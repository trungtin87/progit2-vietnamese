[[_git_hooks]]
=== Móc Git (Git Hooks)

(((hooks)))
Giống như nhiều Hệ thống Kiểm soát Phiên bản khác, Git có một cách để kích hoạt các tập tin kịch bản tùy chỉnh khi các hành động quan trọng nhất định xảy ra.
Có hai nhóm móc này: phía máy khách và phía máy chủ.
Các móc phía máy khách được kích hoạt bởi các hoạt động như commit và trộn, trong khi các móc phía máy chủ chạy trên các hoạt động mạng như nhận các commit được đẩy.
Bạn có thể sử dụng các móc này cho đủ loại lý do.

==== Cài đặt một Móc

Các móc đều được lưu trữ trong thư mục con `hooks` của thư mục Git.
Trong hầu hết các dự án, đó là `.git/hooks`.
Khi bạn khởi tạo một kho chứa mới với `git init`, Git điền vào thư mục hooks một loạt các tập tin kịch bản ví dụ, nhiều trong số đó tự bản thân chúng đã hữu ích; nhưng chúng cũng ghi lại các giá trị đầu vào của mỗi tập tin kịch bản.
Tất cả các ví dụ đều được viết dưới dạng tập tin kịch bản shell, với một chút Perl được thêm vào, nhưng bất kỳ tập tin kịch bản thực thi nào được đặt tên đúng cách sẽ hoạt động tốt – bạn có thể viết chúng bằng Ruby hoặc Python hoặc bất kỳ ngôn ngữ nào bạn quen thuộc.
Nếu bạn muốn sử dụng các tập tin kịch bản móc đi kèm, bạn sẽ phải đổi tên chúng; tên tập tin của chúng đều kết thúc bằng `.sample`.

Để kích hoạt một tập tin kịch bản móc, hãy đặt một tập tin trong thư mục con `hooks` của thư mục `.git` của bạn được đặt tên thích hợp (không có bất kỳ phần mở rộng nào) và có thể thực thi được.
Từ thời điểm đó trở đi, nó sẽ được gọi.
Chúng tôi sẽ đề cập đến hầu hết các tên tập tin móc chính ở đây.

==== Móc Phía Máy Khách

Có rất nhiều móc phía máy khách.
Phần này chia chúng thành các móc quy trình commit, các tập tin kịch bản quy trình email, và mọi thứ khác.

[NOTE]
====
Điều quan trọng cần lưu ý là các móc phía máy khách *không* được sao chép khi bạn sao chép (clone) một kho chứa.
Nếu ý định của bạn với các tập tin kịch bản này là thực thi một chính sách, bạn có thể sẽ muốn làm điều đó ở phía máy chủ; xem ví dụ trong <<ch08-customizing-git#_an_example_git_enforced_policy>>.
====

===== Móc Quy trình Commit

Bốn móc đầu tiên liên quan đến quy trình commit.

Móc `pre-commit` được chạy đầu tiên, trước khi bạn thậm chí gõ vào một thông điệp commit.
Nó được sử dụng để kiểm tra ảnh chụp nhanh sắp được commit, để xem bạn có quên gì không, để đảm bảo các bài kiểm tra chạy, hoặc để kiểm tra bất cứ điều gì bạn cần kiểm tra trong mã.
Thoát với mã khác không từ móc này sẽ hủy bỏ commit, mặc dù bạn có thể bỏ qua nó với `git commit --no-verify`.
Bạn có thể làm những việc như kiểm tra phong cách mã (chạy `lint` hoặc thứ gì đó tương đương), kiểm tra khoảng trắng ở cuối dòng (móc mặc định làm chính xác điều này), hoặc kiểm tra tài liệu thích hợp trên các phương thức mới.

Móc `prepare-commit-msg` được chạy trước khi trình soạn thảo thông điệp commit được kích hoạt nhưng sau khi thông điệp mặc định được tạo.
Nó cho phép bạn chỉnh sửa thông điệp mặc định trước khi tác giả commit nhìn thấy nó.
Móc này nhận một vài tham số: đường dẫn đến tập tin chứa thông điệp commit cho đến nay, loại commit, và SHA-1 commit nếu đây là một commit sửa đổi (amended commit).
Móc này thường không hữu ích cho các commit bình thường; thay vào đó, nó tốt cho các commit mà thông điệp mặc định được tạo tự động, chẳng hạn như các thông điệp commit theo mẫu, các commit trộn, các commit squash, và các commit sửa đổi.
Bạn có thể sử dụng nó kết hợp với một mẫu commit để chèn thông tin theo chương trình.

Móc `commit-msg` nhận một tham số, một lần nữa là đường dẫn đến một tập tin tạm thời chứa thông điệp commit được viết bởi nhà phát triển.
Nếu tập tin kịch bản này thoát với mã khác không, Git sẽ hủy bỏ quy trình commit, vì vậy bạn có thể sử dụng nó để xác thực trạng thái dự án hoặc thông điệp commit của mình trước khi cho phép một commit đi qua.
Trong phần cuối của chương này, chúng tôi sẽ minh họa việc sử dụng móc này để kiểm tra xem thông điệp commit của bạn có tuân thủ một mẫu bắt buộc hay không.

Sau khi toàn bộ quy trình commit hoàn tất, móc `post-commit` chạy.
Nó không nhận bất kỳ tham số nào, nhưng bạn có thể dễ dàng lấy commit cuối cùng bằng cách chạy `git log -1 HEAD`.
Nói chung, tập tin kịch bản này được sử dụng để thông báo hoặc một cái gì đó tương tự.

[[_email_hooks]]
===== Móc Quy trình Email

Bạn có thể thiết lập ba móc phía máy khách cho một quy trình làm việc dựa trên email.
Tất cả chúng đều được gọi bởi lệnh `git am`, vì vậy nếu bạn không sử dụng lệnh đó trong quy trình làm việc của mình, bạn có thể bỏ qua phần tiếp theo một cách an toàn.
Nếu bạn đang nhận các bản vá qua email được chuẩn bị bởi `git format-patch`, thì một số trong số này có thể hữu ích cho bạn.

Móc đầu tiên được chạy là `applypatch-msg`.
Nó nhận một đối số duy nhất: tên của tập tin tạm thời chứa thông điệp commit được đề xuất.
Git hủy bỏ bản vá nếu tập tin kịch bản này thoát với mã khác không.
Bạn có thể sử dụng điều này để đảm bảo một thông điệp commit được định dạng đúng, hoặc để chuẩn hóa thông điệp bằng cách cho tập tin kịch bản chỉnh sửa nó tại chỗ.

Móc tiếp theo chạy khi áp dụng các bản vá thông qua `git am` là `pre-applypatch`.
Hơi khó hiểu, nó được chạy _sau khi_ bản vá được áp dụng nhưng trước khi một commit được thực hiện, vì vậy bạn có thể sử dụng nó để kiểm tra ảnh chụp nhanh trước khi thực hiện commit.
Bạn có thể chạy các bài kiểm tra hoặc kiểm tra cây làm việc với tập tin kịch bản này.
Nếu thiếu thứ gì đó hoặc các bài kiểm tra không vượt qua, thoát với mã khác không sẽ hủy bỏ tập tin kịch bản `git am` mà không commit bản vá.

Móc cuối cùng chạy trong một hoạt động `git am` là `post-applypatch`, chạy sau khi commit được thực hiện.
Bạn có thể sử dụng nó để thông báo cho một nhóm hoặc tác giả của bản vá mà bạn đã kéo vào rằng bạn đã làm như vậy.
Bạn không thể dừng quy trình vá với tập tin kịch bản này.

[[_other_client_hooks]]
===== Các Móc Máy Khách Khác

Móc `pre-rebase` chạy trước khi bạn rebase bất cứ thứ gì và có thể dừng quy trình bằng cách thoát với mã khác không.
Bạn có thể sử dụng móc này để không cho phép rebase bất kỳ commit nào đã được đẩy.
Móc `pre-rebase` ví dụ mà Git cài đặt làm điều này, mặc dù nó đưa ra một số giả định có thể không khớp với quy trình làm việc của bạn.

Móc `post-rewrite` được chạy bởi các lệnh thay thế các commit, chẳng hạn như `git commit --amend` và `git rebase` (mặc dù không phải bởi `git filter-branch`).
Đối số duy nhất của nó là lệnh nào đã kích hoạt việc viết lại, và nó nhận một danh sách các lần viết lại trên `stdin`.
Móc này có nhiều công dụng giống như các móc `post-checkout` và `post-merge`.

Sau khi bạn chạy một `git checkout` thành công, móc `post-checkout` chạy; bạn có thể sử dụng nó để thiết lập thư mục làm việc của mình đúng cách cho môi trường dự án của bạn.
Điều này có thể có nghĩa là di chuyển vào các tập tin nhị phân lớn mà bạn không muốn kiểm soát nguồn, tự động tạo tài liệu, hoặc một cái gì đó tương tự.

Móc `post-merge` chạy sau một lệnh `merge` thành công.
Bạn có thể sử dụng nó để khôi phục dữ liệu trong cây làm việc mà Git không thể theo dõi, chẳng hạn như dữ liệu quyền.
Móc này cũng có thể xác thực sự hiện diện của các tập tin bên ngoài sự kiểm soát của Git mà bạn có thể muốn sao chép vào khi cây làm việc thay đổi.

Móc `pre-push` chạy trong quá trình `git push`, sau khi các tham chiếu từ xa đã được cập nhật nhưng trước khi bất kỳ đối tượng nào được chuyển đi.
Nó nhận tên và vị trí của máy chủ từ xa làm tham số, và một danh sách các tham chiếu sắp được cập nhật thông qua `stdin`.
Bạn có thể sử dụng nó để xác thực một tập hợp các cập nhật tham chiếu trước khi một lần đẩy xảy ra (mã thoát khác không sẽ hủy bỏ lần đẩy).

Git thỉnh thoảng thực hiện thu gom rác như một phần của hoạt động bình thường của nó, bằng cách gọi `git gc --auto`.
Móc `pre-auto-gc` được gọi ngay trước khi việc thu gom rác diễn ra, và có thể được sử dụng để thông báo cho bạn rằng điều này đang xảy ra, hoặc để hủy bỏ việc thu gom nếu bây giờ không phải là thời điểm tốt.

==== Móc Phía Máy Chủ

Ngoài các móc phía máy khách, bạn có thể sử dụng một vài móc phía máy chủ quan trọng với tư cách là quản trị viên hệ thống để thực thi gần như bất kỳ loại chính sách nào cho dự án của bạn.
Các tập tin kịch bản này chạy trước và sau các lần đẩy đến máy chủ.
Các móc pre (trước) có thể thoát với mã khác không bất cứ lúc nào để từ chối lần đẩy cũng như in một thông báo lỗi lại cho máy khách; bạn có thể thiết lập một chính sách đẩy phức tạp như bạn muốn.

===== `pre-receive`

Tập tin kịch bản đầu tiên chạy khi xử lý một lần đẩy từ máy khách là `pre-receive`.
Nó nhận một danh sách các tham chiếu đang được đẩy từ stdin; nếu nó thoát với mã khác không, không có cái nào được chấp nhận.
Bạn có thể sử dụng móc này để làm những việc như đảm bảo không có tham chiếu cập nhật nào là không tua nhanh (non-fast-forwards), hoặc để kiểm soát truy cập cho tất cả các tham chiếu và tập tin họ đang sửa đổi với lần đẩy.

===== `update`

Tập tin kịch bản `update` rất giống với tập tin kịch bản `pre-receive`, ngoại trừ việc nó được chạy một lần cho mỗi nhánh mà người đẩy đang cố gắng cập nhật.
Nếu người đẩy đang cố gắng đẩy đến nhiều nhánh, `pre-receive` chỉ chạy một lần, trong khi `update` chạy một lần cho mỗi nhánh họ đang đẩy đến.
Thay vì đọc từ stdin, tập tin kịch bản này nhận ba đối số: tên của tham chiếu (nhánh), SHA-1 mà tham chiếu trỏ đến trước khi đẩy, và SHA-1 mà người dùng đang cố gắng đẩy.
Nếu tập tin kịch bản `update` thoát với mã khác không, chỉ tham chiếu đó bị từ chối; các tham chiếu khác vẫn có thể được cập nhật.

===== `post-receive`

Móc `post-receive` chạy sau khi toàn bộ quy trình hoàn tất và có thể được sử dụng để cập nhật các dịch vụ khác hoặc thông báo cho người dùng.
Nó nhận cùng dữ liệu stdin như móc `pre-receive`.
Các ví dụ bao gồm gửi email cho một danh sách, thông báo cho máy chủ tích hợp liên tục, hoặc cập nhật hệ thống theo dõi vé – bạn thậm chí có thể phân tích cú pháp các thông điệp commit để xem có vé nào cần được mở, sửa đổi hoặc đóng hay không.
Tập tin kịch bản này không thể dừng quy trình đẩy, nhưng máy khách không ngắt kết nối cho đến khi nó hoàn tất, vì vậy hãy cẩn thận nếu bạn cố gắng làm bất cứ điều gì có thể mất nhiều thời gian.

[TIP]
====
Nếu bạn đang viết một tập tin kịch bản/móc mà người khác sẽ cần đọc, hãy ưu tiên các phiên bản dài của cờ dòng lệnh; sáu tháng sau bạn sẽ cảm ơn chúng tôi.
====
