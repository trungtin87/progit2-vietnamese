[[_smart_http_protocol]]
=== HTTP Thông minh

Bây giờ chúng ta đã đề cập đến những điều cơ bản về các giao thức Git, SSH và Cục bộ.
Tại thời điểm này, bạn có thể thiết lập và chạy một máy chủ Git có quyền đọc/ghi.

Tuy nhiên, có một tùy chọn khác để truy cập mạng: HTTP.
Giao thức HTTP thường bị bỏ qua, vì nó thường đòi hỏi một chút thiết lập ở phía máy chủ.
Tuy nhiên, trong vài năm qua, một số máy chủ Git đã xuất hiện đã làm cho việc hỗ trợ HTTP Thông minh trở nên phổ biến hơn nhiều.

Vì đây là một giao thức không trạng thái chung, HTTP thông thường có thể không hiệu quả để truyền dữ liệu Git.
Tuy nhiên, có thể làm cho việc truyền dữ liệu thông minh hơn, bằng cách để máy chủ diễn giải một cách thông minh các yêu cầu của máy khách.
Đây là ý nghĩa của "HTTP Thông minh".

Để thiết lập một kho lưu trữ Git được phục vụ qua HTTP Thông minh, bạn cần bật một tập lệnh CGI được cung cấp cùng với Git có tên là `git-http-backend`.
Tập lệnh này sẽ đọc đường dẫn và các tiêu đề của yêu cầu được gửi bởi `git fetch` hoặc `git push` đến một URL, và xác định xem máy khách đang cố gắng làm gì.
Nếu tập lệnh CGI thấy rằng máy khách đang cố gắng tìm nạp hoặc đẩy, nó sẽ giao tiếp với máy khách qua một giao thức thông minh.

==== Thiết lập

Để thiết lập CGI `git-http-backend`, trước tiên bạn sẽ cần một máy chủ web có thể chạy các tập lệnh CGI.
Trong ví dụ này, chúng tôi sẽ sử dụng Apache.
Bạn sẽ cần bật các mô-đun `mod_cgi`, `mod_alias`, và `mod_env`.

[source,console]
----
$ sudo a2enmod cgi alias env
----

Bạn cũng sẽ cần đặt biến môi trường `GIT_PROJECT_ROOT`, để `git-http-backend` biết nơi tìm các kho lưu trữ.
Đây phải là gốc của các kho lưu trữ Git của bạn -- thư mục mà bạn có các thư mục `project.git`.

[source,console]
----
SetEnv GIT_PROJECT_ROOT /srv/git
----

Tiếp theo, bạn sẽ cần cấu hình Apache để chạy tập lệnh `git-http-backend` khi bạn truy cập một đường dẫn cụ thể trên máy chủ web của mình.

[source,console]
----
ScriptAlias /git/ /usr/lib/git-core/git-http-backend/
----

Cuối cùng, bạn có thể muốn cho phép ghi vào kho lưu trữ, điều mà bạn có thể làm với một khối cấu hình như thế này:

[source,console]
----
<Location /git/project.git>
    AuthType Basic
    AuthName "Git Access"
    AuthUserFile /srv/git/.htpasswd
    Require valid-user
</Location>
----

Điều này sẽ yêu cầu bạn tạo một tệp `.htpasswd` chứa mật khẩu của tất cả những người dùng hợp lệ.
Đây là một ví dụ về việc thêm người dùng `schacon` vào tệp:

[source,console]
----
$ sudo htpasswd -c /srv/git/.htpasswd schacon
----

Có rất nhiều cách để Apache xác thực người dùng, vì vậy bạn có thể tìm ra cách tích hợp với thiết lập xác thực hiện có của mình.

Bạn cũng có thể cung cấp quyền truy cập chỉ đọc bằng cách xóa phần `Require valid-user`, nhưng bạn vẫn cần cho phép quyền truy cập để đẩy theo một cách khác.
Một cách để làm điều đó là yêu cầu xác thực để đẩy, nhưng cho phép đọc cho mọi người, với một khối như thế này:

[source,console]
----
<Files "git-http-backend">
    AuthType Basic
    AuthName "Git Access"
    AuthUserFile /srv/git/.htpasswd
    Require expr !(%{QUERY_STRING} -strmatch '*service=git-receive-pack*' || %{REQUEST_URI} =~ m#/git-receive-pack$#)
    Require valid-user
</Files>
----