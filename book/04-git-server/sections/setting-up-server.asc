[[_setting_up_server]]
=== Thiết lập Máy chủ

Hãy cùng đi qua việc thiết lập quyền truy cập SSH ở phía máy chủ.
Trong ví dụ này, bạn sẽ sử dụng phương pháp `authorized_keys` để xác thực người dùng của mình.
Chúng tôi cũng giả định bạn đang chạy một bản phân phối Linux tiêu chuẩn như Ubuntu.

[NOTE]
====
Một phần lớn những gì được mô tả ở đây có thể được tự động hóa bằng cách sử dụng lệnh `ssh-copy-id`, thay vì sao chép và cài đặt thủ công các khóa công khai.
====

Đầu tiên, bạn tạo một tài khoản người dùng `git` và một thư mục `.ssh` cho người dùng đó.

[source,console]
----
$ sudo adduser git
$ su git
$ cd
$ mkdir .ssh && chmod 700 .ssh
$ touch .ssh/authorized_keys && chmod 600 .ssh/authorized_keys
----

Tiếp theo, bạn cần thêm một số khóa công khai SSH của nhà phát triển vào tệp `authorized_keys` cho người dùng `git`.
Giả sử bạn có một số khóa công khai đáng tin cậy và đã lưu chúng vào các tệp tạm thời.
Một lần nữa, các khóa công khai trông giống như thế này:

[source,console]
----
$ cat /tmp/id_rsa.john.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCB007n/ww+ouN4gSLKssMxXnBOvf9LGt4L
ojG6rs6hPB09j9R/T17/x4lhJA0F3FR1rP6kYBRsWj2aThGw6HXLm9/5zytK6Ztg3RPKK+4k
Yjh6541NYsnEAZuXz0jTTyAUfrtU3Z5E003C4oxOj6H0rfIF1kKI9MAQLMdpGW1GYEIgS9Ez
Sdfd8AcCIicTDWbqLAcU4UpkaX8KyGlLwsNuuGztobF8m72ALC/nLF6JLtPofwFBlgc+myiv
O7TCUSBdLQlgMVOFq1I2uPWQOkOWQAHukEOmfjy2jctxSDBQ220ymjaNsHT4kgtZg2AYYgPq
dAv8JggJICUvax2T9va5 gsg-keypair
----

Bạn chỉ cần nối chúng vào tệp `authorized_keys` của người dùng `git` trong thư mục `.ssh` của nó:

[source,console]
----
$ cat /tmp/id_rsa.john.pub >> ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.josie.pub >> ~/.ssh/authorized_keys
$ cat /tmp/id_rsa.jessica.pub >> ~/.ssh/authorized_keys
----

Bây giờ, bạn có thể thiết lập một kho lưu trữ trống cho họ bằng cách chạy `git init` với tùy chọn `--bare`, tùy chọn này khởi tạo kho lưu trữ mà không có thư mục làm việc:(((git commands, init, bare)))

[source,console]
----
$ cd /srv/git
$ mkdir project.git
$ cd project.git
$ git init --bare
----

Sau đó, John, Josie, hoặc Jessica có thể đẩy phiên bản đầu tiên của dự án của họ lên máy chủ bằng cách thêm nó làm một điều khiển từ xa và đẩy lên một nhánh.
Lưu ý rằng ai đó phải shell vào máy và tạo một kho lưu trữ trần cho gần như mọi dự án.
Hãy sử dụng `project.git` cho tên dự án.

[source,console]
----
# trên máy của John
$ cd myproject
$ git init
$ git add .
$ git commit -m 'Initial commit'
$ git remote add origin git@gitserver:/srv/git/project.git
$ git push origin master
----

Tại thời điểm này, những người khác có thể sao chép nó xuống và đẩy các thay đổi trở lại dễ dàng như nhau:

[source,console]
----
$ git clone git@gitserver:/srv/git/project.git
$ cd project
$ vim README
$ git commit -am 'Fix for README file'
$ git push origin master
----

Với phương pháp này, bạn có thể nhanh chóng có một máy chủ Git đọc/ghi hoạt động cho một vài nhà phát triển.

Một biện pháp phòng ngừa quan trọng cần thực hiện là hạn chế người dùng `git` chỉ trong các hoạt động Git.
Cách dễ nhất để làm điều đó là thay đổi shell đăng nhập của người dùng `git` thành một công cụ có tên `git-shell` đi kèm với Git.
Nếu bạn đặt đây làm shell đăng nhập của người dùng `git`, thì người dùng đó sẽ không thể có quyền truy cập shell bình thường vào máy chủ của bạn.
Để làm điều này, hãy chỉ định `git-shell` thay vì `bash` hoặc `csh` cho shell đăng nhập của người dùng của bạn.
Bạn thường có thể tìm thấy đường dẫn đầy đủ đến lệnh `git-shell` bằng cách xem trong tệp `/etc/shells` của bạn:

[source,console]
----
$ cat /etc/shells
/bin/sh
/bin/bash
/sbin/nologin
/bin/dash
/bin/zsh
/bin/tcsh
/usr/bin/git-shell
----

Sau đó, bạn có thể thay đổi shell cho một người dùng bằng lệnh `chsh <username>`.

Bây giờ người dùng `git` vẫn có thể sử dụng kết nối SSH để đẩy và kéo từ các kho lưu trữ Git nhưng không thể có được một shell máy.
Nếu họ cố gắng, họ sẽ thấy một từ chối đăng nhập như thế này:

[source,console]
----
$ ssh git@gitserver
fatal: Interactive git shell is not enabled.
hint: ~git/git-shell-commands should exist and have read and execute access.
Connection to gitserver closed.
----

Bây giờ người dùng Git có thể sử dụng kết nối SSH của họ cho những việc khác, ví dụ như thiết lập chuyển tiếp cổng.
Để không cho phép điều đó, bạn có thể chỉnh sửa tệp `authorized_keys` và thêm một số tùy chọn vào đầu mỗi khóa bạn muốn hạn chế.
Các tùy chọn này là (trong số những tùy chọn khác):

* `no-port-forwarding`
* `no-X11-forwarding`
* `no-agent-forwarding`
* `no-pty`

Điều này cho phép người dùng kết nối với máy chủ để đẩy và kéo từ các kho lưu trữ Git, nhưng không có gì khác.
Đây là một ví dụ:

[source,console]
----
no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa
AAAAB3NzaC1yc2EAAAADAQABAAABAQDEwENNMomTboYI+LJieaAY16qiXiH3wuvENhBG...
----

Bây giờ các lệnh mạng Git sẽ vẫn hoạt động tốt nhưng người dùng sẽ không thể có được một shell.
Như đầu ra đã nêu, bạn cũng có thể thiết lập một thư mục trong thư mục chính của người dùng `git` để tùy chỉnh lệnh `git-shell` một chút.
Ví dụ, bạn có thể hạn chế các lệnh Git mà máy chủ sẽ chấp nhận hoặc bạn có thể tùy chỉnh thông báo mà người dùng nhìn thấy nếu họ cố gắng SSH như vậy.
Chạy `git help shell` để biết thêm thông tin về cách tùy chỉnh shell.(((git commands, help)))