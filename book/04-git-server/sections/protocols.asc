[[_protocols]]
=== Các Giao thức

Git có thể sử dụng bốn giao thức mạng chính để truyền dữ liệu: Cục bộ (Local), HTTP, Secure Shell (SSH), và Git.
Ở đây chúng ta sẽ thảo luận về chúng là gì và trong những trường hợp cơ bản nào bạn sẽ muốn (hoặc không muốn) sử dụng chúng.

Điều quan trọng cần lưu ý là ngoại trừ các giao thức HTTP, tất cả các giao thức này đều yêu cầu Git phải được cài đặt và hoạt động trên máy chủ.

[[_local_protocol]]
==== Giao thức Cục bộ

(((protocols, local)))
Cơ bản nhất là _Giao thức Cục bộ_, trong đó kho lưu trữ từ xa nằm trong một thư mục khác trên đĩa.
Điều này thường được sử dụng nếu mọi người trong nhóm của bạn có quyền truy cập vào một hệ thống tệp được chia sẻ như một điểm gắn kết NFS, hoặc trong trường hợp ít xảy ra hơn là mọi người đều đăng nhập vào cùng một máy tính.
Trường hợp sau không lý tưởng, bởi vì tất cả các kho lưu trữ mã của bạn sẽ nằm trên cùng một máy tính, làm tăng khả năng mất mát thảm khốc.

Nếu bạn có một hệ thống tệp được chia sẻ, bạn có thể sao chép, đẩy đến và kéo từ một kho lưu trữ dựa trên tệp cục bộ.
Để sao chép một kho lưu trữ như thế này hoặc để thêm một kho lưu trữ làm điều khiển từ xa vào một dự án hiện có, hãy sử dụng đường dẫn đến kho lưu trữ làm URL.
Ví dụ, để sao chép một kho lưu trữ cục bộ, bạn có thể chạy một cái gì đó như thế này:

[source,console]
----
$ git clone /srv/git/project.git
----

Hoặc bạn có thể làm điều này:

[source,console]
----
$ git clone file:///srv/git/project.git
----

Git hoạt động hơi khác một chút nếu bạn chỉ định rõ ràng `file://` ở đầu URL.
Nếu bạn chỉ chỉ định đường dẫn, Git sẽ cố gắng sử dụng các liên kết cứng hoặc sao chép trực tiếp các tệp mà nó cần.
Nếu bạn chỉ định `file://`, Git sẽ khởi động các quy trình mà nó thường sử dụng để truyền dữ liệu qua mạng, đây là một phương pháp truyền dữ liệu kém hiệu quả hơn nhiều.
Lý do chính để chỉ định tiền tố `file://` là nếu bạn muốn một bản sao sạch của kho lưu trữ không có các tham chiếu hoặc đối tượng không cần thiết, thường là sau khi di chuyển từ một VCS khác hoặc một cái gì đó tương tự (xem <<ch10-git-internals#ch10-git-internals>> để biết các tác vụ bảo trì).
Chúng tôi sẽ sử dụng đường dẫn thông thường ở đây vì làm như vậy gần như luôn nhanh hơn.

Để thêm một kho lưu trữ cục bộ vào một dự án Git hiện có, bạn có thể chạy một cái gì đó như thế này:

[source,console]
----
$ git remote add local_proj /srv/git/project.git
----

Sau đó, bạn có thể đẩy đến và kéo từ điều khiển từ xa đó như thể nó đang ở trên mạng.

===== Ưu điểm

Ưu điểm của các kho lưu trữ dựa trên tệp là chúng đơn giản và chúng sử dụng các quyền truy cập tệp và mạng hiện có.
Nếu bạn đã có một hệ thống tệp được chia sẻ mà toàn bộ nhóm của bạn có quyền truy cập, việc thiết lập một kho lưu trữ rất dễ dàng.
Bạn đặt bản sao kho lưu trữ trần ở một nơi nào đó mà mọi người đều có quyền truy cập chung và thiết lập quyền đọc/ghi như bạn làm cho bất kỳ thư mục chia sẻ nào khác.
Chúng tôi sẽ thảo luận về cách xuất một bản sao kho lưu trữ trần cho mục đích này trong phần tiếp theo, <<_git_on_a_server>>.

Đây cũng là một lựa chọn tốt để nhanh chóng lấy công việc từ kho lưu trữ của người khác.
Nếu bạn và một đồng nghiệp đang làm việc trên cùng một dự án và họ muốn bạn kiểm tra một cái gì đó, việc chạy một lệnh như `git pull /home/john/project` thường dễ dàng hơn là họ đẩy lên một máy chủ từ xa và bạn kéo xuống.

===== Nhược điểm

Nhược điểm của phương pháp này là quyền truy cập chung thường khó thiết lập và tiếp cận hơn từ nhiều vị trí so với quyền truy cập mạng cơ bản.
Nếu bạn muốn đẩy từ máy tính xách tay của mình khi bạn ở nhà, bạn phải gắn kết đĩa từ xa, điều này có thể khó khăn và chậm so với quyền truy cập dựa trên mạng.

Điều quan trọng cần đề cập là đây không nhất thiết là tùy chọn nhanh nhất.
Một kho lưu trữ cục bộ chỉ nhanh khi bạn có quyền truy cập nhanh vào dữ liệu.
Một kho lưu trữ trên một điểm gắn kết NFS thường chậm hơn kho lưu trữ qua SSH trên cùng một máy chủ, cho phép Git chạy trên các đĩa cục bộ trên mỗi hệ thống.

Cuối cùng, giao thức này không bảo vệ kho lưu trữ khỏi thiệt hại vô tình.
Mọi người dùng đều có quyền truy cập shell đầy đủ vào thư mục từ xa, và không có gì ngăn cản họ sửa đổi hoặc xóa các tệp Git nội bộ và làm hỏng kho lưu trữ.

[[_http_protocol]]
==== Các Giao thức HTTP

Git qua HTTP rất phổ biến, vì nó có thể được cấu hình để chạy ở hai chế độ khác nhau.
HTTP thông minh đã là chế độ mặc định để truyền dữ liệu kể từ phiên bản Git 1.6.6, và hoạt động rất giống với các giao thức SSH hoặc Git, nhưng chạy qua các cổng HTTP/S tiêu chuẩn.
HTTP ngu ngốc là một giao thức đơn giản hơn, chỉ đọc và không cần nhiều logic phía máy chủ.

[[_smart_http]]
===== HTTP Thông minh

(((protocols, Smart HTTP)))
Giao thức HTTP "Thông minh" chạy qua các cổng HTTP/S thông thường và có thể sử dụng các cơ chế xác thực HTTP khác nhau.
Bởi vì nó chạy qua các cổng HTTP/S tiêu chuẩn, nó thường có thể đi qua các tường lửa mà nếu không sẽ chặn các giao thức khác.

Nó đã trở nên rất phổ biến trong vài năm qua, vì nó có thể được thiết lập cho cả quyền truy cập chỉ đọc ẩn danh như giao thức `git://`, và cho quyền truy cập đẩy được xác thực như giao thức SSH.
Thay vì phải thiết lập các URL riêng biệt cho những thứ này, bây giờ bạn có thể sử dụng một URL duy nhất cho cả hai.
Nếu bạn cố gắng đẩy và kho lưu trữ yêu cầu xác thực (điều này là bình thường), máy chủ có thể nhắc nhập tên người dùng và mật khẩu.
Điều tương tự cũng đúng với quyền truy cập đọc.

Trên thực tế, đối với các dịch vụ như GitHub, URL bạn sử dụng để xem kho lưu trữ trực tuyến (ví dụ: `https://github.com/schacon/simplegit`) là cùng một URL bạn có thể sử dụng để sao chép, và, nếu bạn có quyền truy cập, để đẩy đến.

===== Giao thức Ngu ngốc

(((protocols, Dumb HTTP)))
Nếu máy chủ _không_ phản hồi với một dịch vụ Git HTTP Thông minh, máy khách Git sẽ cố gắng tiến hành với giao thức HTTP "Ngu ngốc" đơn giản hơn.
Giao thức Ngu ngốc mong đợi kho lưu trữ Git trần được phục vụ như các tệp thông thường từ máy chủ web.
Vẻ đẹp của giao thức Ngu ngốc là sự đơn giản của việc thiết lập nó.
Về cơ bản, tất cả những gì bạn phải làm là đặt một kho lưu trữ Git trần dưới gốc tài liệu HTTP của bạn và thiết lập một hook `post-update` cụ thể (xem <<ch08-customizing-git#_git_hooks>>).
Bây giờ, bất kỳ ai có thể truy cập máy chủ web mà bạn đặt kho lưu trữ cũng có thể sao chép kho lưu trữ của bạn.

Đây là một cách đơn giản để thiết lập quyền truy cập đọc vào một kho lưu trữ qua HTTP Ngu ngốc:

Giả sử bạn có một máy chủ web đang chạy tại `git.example.com` và các kho lưu trữ Git của bạn nằm trong `/srv/git`.
Bạn muốn phục vụ chúng từ thư mục con `/git`.
Đầu tiên, bạn cần tạo thư mục và cho Apache biết đó là một thư mục có thể truy cập web.
Bạn có thể thêm phần sau vào tệp cấu hình Apache của mình (`/etc/apache2/httpd.conf` trên Ubuntu, chẳng hạn):

[source]
----
<Directory /srv/git>
    Options Indexes FollowSymLinks
    AllowOverride None
    Require all granted
</Directory>
----

Sau đó, bạn có thể đặt kho lưu trữ trần vào thư mục đó và thiết lập hook `post-update` để nó sẽ cung cấp thông tin cần thiết cho các máy khách HTTP ngu ngốc:

[source,console]
----
$ cd project.git
$ mv hooks/post-update.sample hooks/post-update
$ chmod a+x hooks/post-update
----

Hook `post-update` này làm gì?
Về cơ bản, nó chạy lệnh `git update-server-info` để đảm bảo rằng việc tìm nạp và sao chép qua HTTP sẽ hoạt động bình thường.
Lệnh này được chạy bất cứ khi nào kho lưu trữ được đẩy đến (qua SSH, chẳng hạn); sau đó, những người khác có thể sao chép bằng cách chạy một cái gì đó như:

[source,console]
----
$ git clone https://git.example.com/git/project.git
----

Trong trường hợp cụ thể này, chúng tôi đang sử dụng đường dẫn `/git/project.git` cho các kho lưu trữ của mình, nhưng bạn có thể thiết lập điều này theo bất kỳ cách nào bạn muốn.
Lệnh `git update-server-info` được chạy theo mặc định, vì vậy việc thiết lập quyền truy cập dựa trên HTTP theo cách này là siêu dễ dàng.

Bạn cũng có thể làm cho kho lưu trữ này có thể ghi qua HTTP, mặc dù điều đó phức tạp hơn một chút.
Chúng tôi sẽ không đề cập đến điều đó ở đây, bởi vì nếu bạn đang ghi vào một kho lưu trữ, việc sử dụng HTTP Thông minh hoặc SSH là một trải nghiệm tốt hơn nhiều.

===== Ưu điểm

Sự đơn giản của giao thức Ngu ngốc làm cho nó phổ biến.
Nếu bạn muốn làm cho một kho lưu trữ chỉ đọc qua HTTP, nó có thể được thiết lập trong vài phút.

HTTP Thông minh có lợi thế là một URL duy nhất cho tất cả các quyền truy cập, mà máy chủ không cần biết trước liệu người dùng sẽ đọc hay ghi.
Nó rất nhanh và hiệu quả, và nó đã trở thành phương pháp phổ biến nhất để lưu trữ Git.

===== Nhược điểm

Nhược điểm chính của HTTP Thông minh là nó không đơn giản để thiết lập ở phía máy chủ.
Nó đòi hỏi một chút cấu hình trên máy chủ để chạy đúng cách.

Nhược điểm của giao thức Ngu ngốc là nó, ừm, ngu ngốc.
Nó chậm và không hiệu quả, và yêu cầu máy khách phải làm rất nhiều việc.
Nó cũng tĩnh, có nghĩa là nếu đó là cách duy nhất một kho lưu trữ được phục vụ, bạn sẽ cần chạy `git update-server-info` trên máy chủ mỗi khi một thay đổi được đẩy để giữ cho nó được cập nhật.

[[_ssh_protocol]]
==== Giao thức SSH

(((protocols, SSH)))
Một giao thức truyền tải phổ biến cho Git khi tự lưu trữ là SSH.
Điều này là do quyền truy cập SSH vào các máy chủ đã được thiết lập ở hầu hết các nơi -- và nếu không, nó rất dễ thực hiện.
SSH cũng là một giao thức mạng được xác thực và, bởi vì nó có mặt ở khắp mọi nơi, nó thường dễ thiết lập và sử dụng.

Để sao chép một kho lưu trữ Git qua SSH, bạn có thể chỉ định một URL `ssh://` như sau:

[source,console]
----
$ git clone ssh://user@server/project.git
----

Hoặc bạn có thể sử dụng cú pháp giống như `scp` phổ biến hơn cho giao thức SSH:

[source,console]
----
$ git clone user@server:project.git
----

Bạn cũng có thể không chỉ định người dùng, và Git sẽ sử dụng người dùng bạn hiện đang đăng nhập.

===== Ưu điểm

Ưu điểm của việc sử dụng SSH là rất nhiều.
Đầu tiên, SSH tương đối dễ thiết lập -- các daemon SSH là phổ biến, nhiều quản trị viên mạng có kinh nghiệm với chúng, và nhiều bản phân phối hệ điều hành được thiết lập với chúng hoặc có các công cụ để quản lý chúng.
Thứ hai, quyền truy cập qua SSH là an toàn -- tất cả dữ liệu truyền đi đều được mã hóa và xác thực.
Cuối cùng, giống như các giao thức HTTP/S, Git, và Cục bộ, SSH hiệu quả, làm cho dữ liệu nhỏ gọn nhất có thể trước khi truyền đi.

===== Nhược điểm

Mặt tiêu cực của SSH là nó không hỗ trợ quyền truy cập ẩn danh vào kho lưu trữ Git của bạn.
Nếu bạn đang sử dụng SSH, người dùng _phải_ có quyền truy cập SSH vào máy của bạn, ngay cả đối với quyền truy cập chỉ đọc, điều này không làm cho SSH có lợi cho các dự án mã nguồn mở.
Nếu bạn chỉ sử dụng nó trong mạng công ty của mình, SSH có thể là giao thức duy nhất bạn cần xử lý.
Nếu bạn muốn cho phép quyền truy cập chỉ đọc ẩn danh vào các dự án của mình và cũng sử dụng SSH, bạn phải thiết lập SSH để bạn đẩy qua nhưng một cái gì đó khác để người khác kéo từ đó.

[[_git_protocol]]
==== Giao thức Git

(((protocols, Git)))
Cuối cùng chúng ta có giao thức Git.
Đây là một daemon đặc biệt đi kèm với Git; nó lắng nghe trên một cổng chuyên dụng (9418) cung cấp một dịch vụ tương tự như giao thức SSH, nhưng không có xác thực.
Để một kho lưu trữ được phục vụ qua giao thức Git, bạn phải tạo một tệp `git-daemon-export-ok` -- daemon sẽ không phục vụ một kho lưu trữ nếu không có tệp đó trong đó -- nhưng ngoài ra không có bảo mật nào khác.
Hoặc là kho lưu trữ Git có sẵn cho mọi người sao chép hoặc không.
Điều này có nghĩa là thường không có việc đẩy qua giao thức này.
Bạn có thể bật quyền truy cập đẩy, nhưng với việc thiếu xác thực, nếu bạn bật quyền truy cập đẩy, bất kỳ ai trên internet tìm thấy URL của dự án của bạn đều có thể đẩy vào dự án của bạn.
Chỉ cần nói rằng, điều này là hiếm.

===== Ưu điểm

Giao thức Git thường là giao thức truyền tải mạng nhanh nhất hiện có.
Nếu bạn đang phục vụ rất nhiều lưu lượng truy cập cho một dự án công cộng hoặc phục vụ một dự án rất lớn không yêu cầu xác thực người dùng để truy cập đọc, có khả năng bạn sẽ muốn thiết lập một daemon Git để phục vụ dự án của mình.
Nó sử dụng cùng một cơ chế truyền dữ liệu như giao thức SSH nhưng không có chi phí mã hóa và xác thực.

===== Nhược điểm

Nhược điểm của giao thức Git là thiếu xác thực.
Thường thì không mong muốn giao thức Git là quyền truy cập duy nhất vào dự án của bạn.
Nói chung, bạn sẽ ghép nối nó với quyền truy cập SSH hoặc HTTPS cho một số ít nhà phát triển có quyền đẩy (ghi) và để mọi người khác sử dụng `git://` để truy cập chỉ đọc.

Nó cũng có lẽ là giao thức khó thiết lập nhất.
Nó phải chạy daemon riêng của mình, yêu cầu cấu hình `xinetd` hoặc `systemd` hoặc tương tự, điều này không phải lúc nào cũng dễ dàng.
Nó cũng yêu cầu quyền truy cập tường lửa vào cổng 9418, đây không phải là một cổng tiêu chuẩn mà các tường lửa của công ty luôn cho phép.
Đằng sau các tường lửa lớn của công ty, cổng khó hiểu này thường bị chặn.