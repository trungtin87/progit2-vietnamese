[[_remote_branches]]
=== Các Nhánh Từ xa

(((branches, remote)))(((references, remote)))
Các tham chiếu từ xa (remote references) là các tham chiếu (con trỏ) trong kho lưu trữ từ xa của bạn, bao gồm các nhánh, thẻ, v.v.
Bạn có thể nhận được danh sách đầy đủ các tham chiếu từ xa một cách rõ ràng bằng `git ls-remote <remote>`, hoặc `git remote show <remote>` cho các nhánh từ xa cũng như nhiều thông tin khác.
Tuy nhiên, một cách phổ biến hơn là tận dụng các nhánh theo dõi từ xa (remote-tracking branches).

Các nhánh theo dõi từ xa là các tham chiếu đến trạng thái của các nhánh từ xa.
Chúng là các tham chiếu cục bộ mà bạn không thể di chuyển; Git di chuyển chúng cho bạn bất cứ khi nào bạn thực hiện bất kỳ giao tiếp mạng nào, để đảm bảo chúng thể hiện chính xác trạng thái của kho lưu trữ từ xa.
Hãy nghĩ về chúng như những dấu trang (bookmarks) để nhắc nhở bạn về vị trí của các nhánh trên kho lưu trữ từ xa của bạn vào lần cuối cùng bạn kết nối với chúng.

Tên nhánh theo dõi từ xa có dạng `<remote>/<branch>`.
Ví dụ: nếu bạn muốn xem nhánh `master` trên remote `origin` của mình trông như thế nào vào lần cuối cùng bạn giao tiếp với nó, bạn sẽ kiểm tra nhánh `origin/master`.
Nếu bạn đang làm việc trên một vấn đề với một đối tác và họ đã đẩy lên một nhánh `iss53`, bạn có thể có nhánh `iss53` cục bộ của riêng mình; nhưng nhánh trên máy chủ sẽ được đại diện bởi nhánh theo dõi từ xa `origin/iss53`.

Điều này có thể hơi khó hiểu, vì vậy hãy xem xét một ví dụ.
Giả sử bạn có một máy chủ Git trên mạng của mình tại `git.ourcompany.com`.
Nếu bạn sao chép từ đây, lệnh `git clone` của Git sẽ tự động đặt tên cho nó là `origin` cho bạn, kéo xuống tất cả dữ liệu của nó, tạo một con trỏ đến nơi nhánh `master` của nó đang ở và đặt tên cục bộ là `origin/master`.
Git cũng cung cấp cho bạn nhánh `master` cục bộ của riêng bạn bắt đầu từ cùng một nơi với nhánh `master` của origin, vì vậy bạn có một cái gì đó để làm việc.

[NOTE]
."`origin`" không đặc biệt
====
Cũng giống như tên nhánh "`master`" không có ý nghĩa đặc biệt nào trong Git, "`origin`" cũng không có ý nghĩa đặc biệt nào.
`master` là tên mặc định cho một nhánh bắt đầu khi bạn chạy `git init` là lý do duy nhất khiến nó được sử dụng rộng rãi, và `origin` là tên mặc định cho một remote khi bạn chạy `git clone`.
Nếu bạn chạy `git clone -o booyah` thay thế, thì bạn sẽ có `booyah/master` làm nhánh từ xa mặc định của mình.(((origin)))
====

.Máy chủ và kho lưu trữ cục bộ sau khi sao chép
image::images/remote-branches-1.png[Máy chủ và kho lưu trữ cục bộ sau khi sao chép]

Nếu bạn thực hiện một số công việc trên nhánh `master` cục bộ của mình, và trong khi đó, ai đó khác đẩy lên `git.ourcompany.com` và cập nhật nhánh `master` của nó, thì lịch sử của bạn sẽ di chuyển về phía trước theo cách khác.
Ngoài ra, miễn là bạn không liên lạc với máy chủ origin của mình, con trỏ `origin/master` của bạn sẽ không di chuyển.

.Công việc cục bộ và từ xa có thể phân kỳ
image::images/remote-branches-2.png[Công việc cục bộ và từ xa có thể phân kỳ]

Để đồng bộ hóa công việc của bạn với một remote nhất định, bạn chạy lệnh `git fetch <remote>` (trong trường hợp của chúng ta là `git fetch origin`).
Lệnh này tra cứu máy chủ nào là "`origin`" (trong trường hợp này là `git.ourcompany.com`), lấy bất kỳ dữ liệu nào từ nó mà bạn chưa có, và cập nhật cơ sở dữ liệu cục bộ của bạn, di chuyển con trỏ `origin/master` của bạn đến vị trí mới, cập nhật hơn của nó.

.git fetch cập nhật các con trỏ theo dõi từ xa của bạn
image::images/remote-branches-3.png[git fetch cập nhật các con trỏ theo dõi từ xa của bạn]

Để chứng minh việc có nhiều máy chủ từ xa và các nhánh từ xa cho các dự án từ xa đó trông như thế nào, hãy giả sử bạn có một máy chủ Git nội bộ khác chỉ được sử dụng để phát triển bởi một trong các nhóm chạy nước rút (sprint) của bạn.
Máy chủ này tại `git.team1.ourcompany.com`.
Bạn có thể thêm nó làm tham chiếu từ xa mới cho dự án bạn đang làm việc bằng cách chạy lệnh `git remote add` như chúng ta đã đề cập trong <<ch02-git-basics-chapter#ch02-git-basics-chapter>>.
Đặt tên cho remote này là `teamone`, đây sẽ là tên viết tắt của bạn cho toàn bộ URL đó.

.Thêm một máy chủ từ xa khác
image::images/remote-branches-4.png[Thêm một máy chủ từ xa khác]

Bây giờ, bạn có thể chạy `git fetch teamone` để lấy mọi thứ mà máy chủ `teamone` có mà bạn chưa có.
Bởi vì máy chủ đó có một tập hợp con dữ liệu mà máy chủ `origin` của bạn có ngay bây giờ, Git không lấy bất kỳ dữ liệu nào nhưng đặt một nhánh theo dõi từ xa có tên `teamone/master` để trỏ đến cam kết mà `teamone` có làm nhánh `master` của nó.

.Nhánh theo dõi từ xa cho teamone/master
image::images/remote-branches-5.png[Nhánh theo dõi từ xa cho teamone/master]

[[_pushing_branches]]
==== Đẩy (Pushing)

(((pushing)))
Khi bạn muốn chia sẻ một nhánh với mọi người, bạn cần đẩy nó lên một remote mà bạn có quyền ghi.
Các nhánh cục bộ của bạn không được tự động đồng bộ hóa với các remote bạn ghi vào -- bạn phải đẩy rõ ràng các nhánh bạn muốn chia sẻ.
Bằng cách đó, bạn có thể sử dụng các nhánh riêng tư cho công việc bạn không muốn chia sẻ và chỉ đẩy lên các nhánh chủ đề mà bạn muốn cộng tác.

Nếu bạn có một nhánh tên là `serverfix` mà bạn muốn làm việc với những người khác, bạn có thể đẩy nó lên giống như cách bạn đã đẩy nhánh đầu tiên của mình.
Chạy `git push <remote> <branch>`:(((git commands, push)))

[source,console]
----
$ git push origin serverfix
Counting objects: 24, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (15/15), done.
Writing objects: 100% (24/24), 1.91 KiB | 0 bytes/s, done.
Total 24 (delta 2), reused 0 (delta 0)
To https://github.com/schacon/simplegit
 * [new branch]      serverfix -> serverfix
----

Đây là một chút đường tắt.
Git tự động mở rộng tên nhánh `serverfix` thành `refs/heads/serverfix:refs/heads/serverfix`, có nghĩa là, "Lấy nhánh serverfix cục bộ của tôi và đẩy nó để cập nhật nhánh serverfix từ xa."
Chúng ta sẽ xem xét phần `refs/heads/` chi tiết trong <<ch10-git-internals#ch10-git-internals>>, nhưng bạn thường có thể bỏ qua nó.
Bạn cũng có thể thực hiện `git push origin serverfix:serverfix`, làm điều tương tự -- nó nói, "Lấy serverfix của tôi và biến nó thành serverfix của remote."
Bạn có thể sử dụng định dạng này để đẩy một nhánh cục bộ vào một nhánh từ xa có tên khác.
Nếu bạn không muốn nó được gọi là `serverfix` trên remote, thay vào đó bạn có thể chạy `git push origin serverfix:awesomebranch` để đẩy nhánh `serverfix` cục bộ của bạn lên nhánh `awesomebranch` trên dự án từ xa.

[NOTE]
.Đừng nhập mật khẩu của bạn mỗi lần.
====
Nếu bạn đang sử dụng URL HTTPS để đẩy qua, máy chủ Git sẽ hỏi bạn tên người dùng và mật khẩu để xác thực.
Theo mặc định, nó sẽ nhắc bạn trên thiết bị đầu cuối để nhập thông tin này để máy chủ có thể xác định xem bạn có được phép đẩy hay không.

Nếu bạn không muốn nhập nó mỗi lần bạn đẩy, bạn có thể thiết lập "bộ nhớ đệm thông tin xác thực" (credential cache).
Cách đơn giản nhất là chỉ cần giữ nó trong bộ nhớ trong vài phút, bạn có thể dễ dàng thiết lập bằng cách chạy `git config --global credential.helper cache`.

Để biết thêm thông tin về các tùy chọn bộ nhớ đệm thông tin xác thực khác nhau có sẵn, xem <<ch07-git-tools#_credential_caching>>.
====

Lần tới khi một trong những cộng tác viên của bạn lấy từ máy chủ, họ sẽ nhận được tham chiếu đến nơi phiên bản `serverfix` của máy chủ nằm dưới nhánh theo dõi từ xa `origin/serverfix`:

[source,console]
----
$ git fetch origin
remote: Counting objects: 7, done.
remote: Compressing objects: 100% (2/2), done.
remote: Total 3 (delta 0), reused 3 (delta 0)
Unpacking objects: 100% (3/3), done.
From https://github.com/schacon/simplegit
 * [new branch]      serverfix    -> origin/serverfix
----

Điều quan trọng cần lưu ý là khi bạn thực hiện tìm nạp (fetch) mang xuống các nhánh theo dõi từ xa mới, bạn không tự động có các bản sao cục bộ, có thể chỉnh sửa của chúng.
Nói cách khác, trong trường hợp này, bạn không có nhánh `serverfix` mới -- bạn chỉ có một con trỏ `origin/serverfix` mà bạn không thể sửa đổi.

Để hợp nhất công việc này vào nhánh làm việc hiện tại của bạn, bạn có thể chạy `git merge origin/serverfix`.
Nếu bạn muốn có nhánh `serverfix` của riêng mình để bạn có thể làm việc trên đó, bạn có thể dựa trên nhánh theo dõi từ xa của mình:

[source,console]
----
$ git checkout -b serverfix origin/serverfix
Branch serverfix set up to track remote branch serverfix from origin.
Switched to a new branch 'serverfix'
----

Điều này cung cấp cho bạn một nhánh cục bộ mà bạn có thể làm việc trên đó bắt đầu từ nơi `origin/serverfix` đang ở.

[[_tracking_branches]]
==== Các Nhánh Theo dõi

(((branches, tracking)))(((branches, upstream)))
Kiểm xuất một nhánh cục bộ từ một nhánh theo dõi từ xa sẽ tự động tạo ra cái được gọi là "nhánh theo dõi" (tracking branch) (và nhánh nó theo dõi được gọi là "nhánh thượng nguồn" - upstream branch).
Các nhánh theo dõi là các nhánh cục bộ có mối quan hệ trực tiếp với một nhánh từ xa.
Nếu bạn đang ở trên một nhánh theo dõi và gõ `git pull`, Git sẽ tự động biết máy chủ nào để lấy và nhánh nào để hợp nhất vào.

Khi bạn sao chép một kho lưu trữ, nó thường tự động tạo một nhánh `master` theo dõi `origin/master`.
Tuy nhiên, bạn có thể thiết lập các nhánh theo dõi khác nếu bạn muốn -- những nhánh theo dõi các nhánh trên các remote khác hoặc không theo dõi nhánh `master`.
Trường hợp đơn giản là ví dụ bạn vừa thấy, chạy `git checkout -b <branch> <remote>/<branch>`.
Đây là một thao tác đủ phổ biến đến nỗi Git cung cấp cờ tắt `--track`:

[source,console]
----
$ git checkout --track origin/serverfix
Branch serverfix set up to track remote branch serverfix from origin.
Switched to a new branch 'serverfix'
----

Trên thực tế, điều này phổ biến đến mức thậm chí còn có một lối tắt cho lối tắt đó.
Nếu tên nhánh bạn đang cố gắng kiểm xuất (a) không tồn tại và (b) khớp chính xác với tên trên chỉ một remote, Git sẽ tạo một nhánh theo dõi cho bạn:

[source,console]
----
$ git checkout serverfix
Branch serverfix set up to track remote branch serverfix from origin.
Switched to a new branch 'serverfix'
----

Để thiết lập một nhánh cục bộ với tên khác với nhánh từ xa, bạn có thể dễ dàng sử dụng phiên bản đầu tiên với tên nhánh cục bộ khác:

[source,console]
----
$ git checkout -b sf origin/serverfix
Branch sf set up to track remote branch serverfix from origin.
Switched to a new branch 'sf'
----

Bây giờ, nhánh cục bộ `sf` của bạn sẽ tự động kéo từ `origin/serverfix`.

Nếu bạn đã có một nhánh cục bộ và muốn đặt nó thành một nhánh từ xa bạn vừa kéo xuống, hoặc muốn thay đổi nhánh thượng nguồn bạn đang theo dõi, bạn có thể sử dụng tùy chọn `-u` hoặc `--set-upstream-to` cho `git branch` để đặt rõ ràng nó bất cứ lúc nào.

[source,console]
----
$ git branch -u origin/serverfix
Branch serverfix set up to track remote branch serverfix from origin.
----

[NOTE]
.Thượng nguồn viết tắt
====
Khi bạn đã thiết lập nhánh theo dõi, bạn có thể tham chiếu nhánh thượng nguồn của nó bằng cách viết tắt `@{upstream}` hoặc `@{u}`.
Vì vậy, nếu bạn đang ở trên nhánh `master` và nó đang theo dõi `origin/master`, bạn có thể nói điều gì đó giống như `git merge @{u}` thay vì `git merge origin/master`.(((@{u})))(((@{upstream})))
====

Nếu bạn muốn xem những nhánh theo dõi nào bạn đã thiết lập, bạn có thể sử dụng tùy chọn `-vv` cho `git branch`.
Điều này sẽ liệt kê các nhánh cục bộ của bạn với nhiều thông tin hơn bao gồm những gì mỗi nhánh đang theo dõi và liệu nhánh cục bộ của bạn đang đi trước, đi sau hay cả hai.

[source,console]
----
$ git branch -vv
  iss53     7e424c3 [origin/iss53: ahead 2] forgot the brackets
  master    1ae2a45 [origin/master] deploying index fix
* serverfix f8674d9 [teamone/server-fix-good: ahead 3, behind 1] this should do it
  testing   5ea463a trying something new
----

Vì vậy, ở đây chúng ta có thể thấy rằng nhánh `iss53` của chúng ta đang theo dõi `origin/iss53` và đang "đi trước" (ahead) hai, nghĩa là chúng ta có hai cam kết cục bộ chưa được đẩy lên máy chủ.
Chúng ta cũng có thể thấy rằng nhánh `master` của chúng ta đang theo dõi `origin/master` và được cập nhật.
Tiếp theo, chúng ta có thể thấy rằng nhánh `serverfix` của chúng ta đang theo dõi nhánh `server-fix-good` trên máy chủ `teamone` của chúng ta và đi trước ba và đi sau một, nghĩa là có một cam kết trên máy chủ mà chúng ta chưa hợp nhất và ba cam kết cục bộ mà chúng ta chưa đẩy.
Cuối cùng, nhánh `testing` của chúng ta không theo dõi bất kỳ nhánh từ xa nào.

Điều quan trọng cần lưu ý là những con số này chỉ nói về lần cuối cùng bạn lấy từ mỗi máy chủ.
Lệnh này không tiếp cận các máy chủ, nó cho bạn biết về những gì nó đã lưu trữ từ các máy chủ này lần cuối cùng bạn nói chuyện với chúng.
Nếu bạn muốn hoàn toàn cập nhật các số đi trước và đi sau này, bạn sẽ cần lấy từ tất cả các remote của mình ngay trước khi chạy cái này.
Bạn có thể làm điều đó như thế này:

[source,console]
----
$ git fetch --all; git branch -vv
----

[[_pulling]]
==== Kéo (Pulling)

(((pulling)))
Trong khi lệnh `git fetch` sẽ lấy xuống tất cả các thay đổi trên máy chủ mà bạn chưa có, nó sẽ không sửa đổi thư mục làm việc của bạn chút nào.
Nó sẽ chỉ lấy dữ liệu và để bạn tự hợp nhất nó.
Tuy nhiên, có một lệnh gọi là `git pull` về cơ bản là `git fetch` ngay lập tức theo sau là `git merge` trong hầu hết các trường hợp.
Nếu bạn có một nhánh theo dõi được thiết lập như đã trình bày trong phần trước, bằng cách thiết lập rõ ràng hoặc bằng cách tạo nó cho bạn bằng các lệnh `clone` hoặc `checkout`, `git pull` sẽ tra cứu máy chủ và nhánh nào nhánh hiện tại của bạn đang theo dõi, tìm nạp từ máy chủ đó và sau đó cố gắng hợp nhất nhánh từ xa đó vào.

Nói chung, tốt hơn là chỉ cần sử dụng các lệnh `fetch` và `merge` một cách rõ ràng vì sự kỳ diệu của `git pull` thường có thể gây nhầm lẫn.

[[_delete_branches]]
==== Xóa Nhánh Từ xa

(((branches, deleting remote)))
Giả sử bạn đã hoàn thành một nhánh từ xa -- giả sử bạn và các cộng tác viên của bạn đã hoàn thành một tính năng và đã hợp nhất nó vào nhánh `master` của remote của bạn (hoặc bất kỳ nhánh nào mà dòng mã ổn định của bạn đang ở).
Bạn có thể xóa một nhánh từ xa bằng tùy chọn `--delete` cho `git push`.
Nếu bạn muốn xóa nhánh `serverfix` của mình khỏi máy chủ, bạn chạy như sau:

[source,console]
----
$ git push origin --delete serverfix
To https://github.com/schacon/simplegit
 - [deleted]         serverfix
----

Về cơ bản, tất cả những gì làm là xóa con trỏ khỏi máy chủ.
Máy chủ Git thường giữ dữ liệu ở đó trong một thời gian cho đến khi bộ thu gom rác chạy, vì vậy nếu nó vô tình bị xóa, thường dễ dàng khôi phục.
