==== Subversion

(((Subversion)))
(((Importing, from Subversion)))
Nếu bạn đọc phần trước về việc sử dụng `git svn`, bạn có thể dễ dàng sử dụng các hướng dẫn đó để `git svn clone` một kho chứa; sau đó, ngừng sử dụng máy chủ Subversion, đẩy lên một máy chủ Git mới, và bắt đầu sử dụng nó.
Nếu bạn muốn lịch sử, bạn có thể hoàn thành điều đó nhanh như bạn có thể kéo dữ liệu ra khỏi máy chủ Subversion (có thể mất một lúc).

Tuy nhiên, việc nhập không hoàn hảo; và vì nó sẽ mất rất lâu, bạn cũng có thể làm nó đúng cách.
Vấn đề đầu tiên là thông tin tác giả.
Trong Subversion, mỗi người commit có một người dùng trên hệ thống được ghi lại trong thông tin commit.
Các ví dụ trong phần trước hiển thị `schacon` ở một số nơi, chẳng hạn như đầu ra `blame` và `git svn log`.
Nếu bạn muốn ánh xạ điều này sang dữ liệu tác giả Git tốt hơn, bạn cần một ánh xạ từ người dùng Subversion sang tác giả Git.
Tạo một tập tin có tên `users.txt` có ánh xạ này theo định dạng như thế này:

[source]
----
schacon = Scott Chacon <schacon@geemail.com>
selse = Someo Nelse <selse@geemail.com>
----

Để lấy danh sách tên tác giả mà SVN sử dụng, bạn có thể chạy lệnh này:

[source,console]
----
$ svn log --xml --quiet | grep author | sort -u | \
  perl -pe 's/.*>(.*?)<.*/$1 = /'
----

Lệnh đó tạo ra đầu ra nhật ký ở định dạng XML, sau đó chỉ giữ các dòng có thông tin tác giả, loại bỏ các bản sao, loại bỏ các thẻ XML.
Rõ ràng điều này chỉ hoạt động trên một máy có cài đặt `grep`, `sort`, và `perl`.
Sau đó, chuyển hướng đầu ra đó vào tập tin `users.txt` của bạn để bạn có thể thêm dữ liệu người dùng Git tương đương bên cạnh mỗi mục.

[NOTE]
====
Nếu bạn đang thử điều này trên một máy Windows, đây là điểm mà bạn sẽ gặp rắc rối.
Microsoft đã cung cấp một số lời khuyên và mẫu tốt tại https://learn.microsoft.com/en-us/azure/devops/repos/git/perform-migration-from-svn-to-git[^].
====

Bạn có thể cung cấp tập tin này cho `git svn` để giúp nó ánh xạ dữ liệu tác giả chính xác hơn.
Bạn cũng có thể bảo `git svn` không bao gồm siêu dữ liệu mà Subversion thường nhập, bằng cách truyền `--no-metadata` cho lệnh `clone` hoặc `init`.
Siêu dữ liệu bao gồm một `git-svn-id` bên trong mỗi thông điệp commit mà Git sẽ tạo trong quá trình nhập.
Điều này có thể làm phình to nhật ký Git của bạn và có thể làm cho nó hơi không rõ ràng.

[NOTE]
====
Bạn cần giữ siêu dữ liệu khi bạn muốn phản chiếu các commit được thực hiện trong kho chứa Git trở lại kho chứa SVN gốc.
Nếu bạn không muốn đồng bộ hóa trong nhật ký commit của mình, hãy thoải mái bỏ qua tham số `--no-metadata`.
====

Điều này làm cho lệnh `import` của bạn trông như thế này:

[source,console]
----
$ git svn clone http://my-project.googlecode.com/svn/ \
      --authors-file=users.txt --no-metadata --prefix "" -s my_project
$ cd my_project
----

Bây giờ bạn nên có một bản nhập Subversion đẹp hơn trong thư mục `my_project` của bạn.
Thay vì các commit trông như thế này:

[source]
----
commit 37efa680e8473b615de980fa935944215428a35a
Author: schacon <schacon@4c93b258-373f-11de-be05-5f7a86268029>
Date:   Sun May 3 00:12:22 2009 +0000

    fixed install - go to trunk

    git-svn-id: https://my-project.googlecode.com/svn/trunk@94 4c93b258-373f-11de-
    be05-5f7a86268029
----

chúng trông như thế này:

[source]
----
commit 03a8785f44c8ea5cdb0e8834b7c8e6c469be2ff2
Author: Scott Chacon <schacon@geemail.com>
Date:   Sun May 3 00:12:22 2009 +0000

    fixed install - go to trunk
----

Không chỉ trường Author trông tốt hơn nhiều, mà `git-svn-id` cũng không còn ở đó nữa.

Bạn cũng nên thực hiện một chút dọn dẹp sau khi nhập.
Trước hết, bạn nên dọn dẹp các tham chiếu kỳ lạ mà `git svn` đã thiết lập.
Đầu tiên bạn sẽ di chuyển các thẻ để chúng là các thẻ thực sự thay vì các nhánh từ xa lạ, và sau đó bạn sẽ di chuyển phần còn lại của các nhánh để chúng là cục bộ.

Để di chuyển các thẻ thành các thẻ Git thích hợp, hãy chạy:

[source,console]
----
$ for t in $(git for-each-ref --format='%(refname:short)' refs/remotes/tags); do git tag ${t/tags\//} $t && git branch -D -r $t; done
----

Lệnh này lấy các tham chiếu là các nhánh từ xa bắt đầu bằng `refs/remotes/tags/` và biến chúng thành các thẻ thực sự (nhẹ).

Tiếp theo, di chuyển phần còn lại của các tham chiếu dưới `refs/remotes` thành các nhánh cục bộ:

[source,console]
----
$ for b in $(git for-each-ref --format='%(refname:short)' refs/remotes); do git branch $b refs/remotes/$b && git branch -D -r $b; done
----

Có thể xảy ra rằng bạn sẽ thấy một số nhánh bổ sung được hậu tố bởi `@xxx` (trong đó xxx là một số), trong khi trong Subversion bạn chỉ thấy một nhánh.
Đây thực sự là một tính năng Subversion gọi là "`peg-revisions`", đó là thứ mà Git đơn giản không có đối tác cú pháp.
Do đó, `git svn` chỉ đơn giản thêm số phiên bản SVN vào tên nhánh theo cùng một cách như bạn sẽ viết nó trong SVN để giải quyết peg-revision của nhánh đó.
Nếu bạn không còn quan tâm đến peg-revisions nữa, chỉ cần xóa chúng:

[source,console]
----
$ for p in $(git for-each-ref --format='%(refname:short)' | grep @); do git branch -D $p; done
----

Bây giờ tất cả các nhánh cũ là các nhánh Git thực sự và tất cả các thẻ cũ là các thẻ Git thực sự.

Có một điều cuối cùng để dọn dẹp.
Thật không may, `git svn` tạo một nhánh bổ sung có tên `trunk`, ánh xạ đến nhánh mặc định của Subversion, nhưng tham chiếu `trunk` trỏ đến cùng một nơi như `master`.
Vì `master` là thành ngữ Git hơn, đây là cách xóa nhánh bổ sung:

[source,console]
----
$ git branch -d trunk
----

Điều cuối cùng cần làm là thêm máy chủ Git mới của bạn làm máy từ xa và đẩy lên nó.
Đây là một ví dụ về việc thêm máy chủ của bạn làm máy từ xa:

[source,console]
----
$ git remote add origin git@my-git-server:myrepository.git
----

Vì bạn muốn tất cả các nhánh và thẻ của mình được đẩy lên, bây giờ bạn có thể chạy lệnh này:

[source,console]
----
$ git push origin --all
$ git push origin --tags
----

Tất cả các nhánh và thẻ của bạn nên có trên máy chủ Git mới của bạn trong một bản nhập đẹp, sạch sẽ.
