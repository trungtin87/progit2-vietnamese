==== Git và Mercurial

(((Interoperation with other VCSs, Mercurial)))
(((Mercurial)))
Vũ trụ DVCS lớn hơn không chỉ có Git.
Trên thực tế, có nhiều hệ thống khác trong không gian này, mỗi hệ thống có góc nhìn riêng về cách thực hiện kiểm soát phiên bản phân tán một cách chính xác.
Ngoài Git, phổ biến nhất là Mercurial, và cả hai rất giống nhau về nhiều mặt.

Tin tốt, nếu bạn thích hành vi phía máy khách của Git nhưng đang làm việc với một dự án có mã nguồn được kiểm soát bằng Mercurial, là có một cách để sử dụng Git như một máy khách cho một kho chứa được lưu trữ bằng Mercurial.
Vì cách Git nói chuyện với các kho chứa máy chủ là thông qua các máy từ xa (remotes), nên không có gì ngạc nhiên khi cầu nối này được triển khai như một trình trợ giúp từ xa (remote helper).
Tên của dự án là git-remote-hg, và nó có thể được tìm thấy tại https://github.com/felipec/git-remote-hg[^].

===== git-remote-hg

Đầu tiên, bạn cần cài đặt git-remote-hg.
Về cơ bản, điều này đòi hỏi phải thả tập tin của nó vào đâu đó trong đường dẫn của bạn, như sau:

[source,console]
----
$ curl -o ~/bin/git-remote-hg \
  https://raw.githubusercontent.com/felipec/git-remote-hg/master/git-remote-hg
$ chmod +x ~/bin/git-remote-hg
----

…giả sử `~/bin` nằm trong `$PATH` của bạn.
Git-remote-hg có một phụ thuộc khác: thư viện `mercurial` cho Python.
Nếu bạn đã cài đặt Python, điều này đơn giản như sau:

[source,console]
----
$ pip install mercurial
----

Nếu bạn chưa cài đặt Python, hãy truy cập https://www.python.org/[^] và tải nó trước.

Điều cuối cùng bạn sẽ cần là máy khách Mercurial.
Truy cập https://www.mercurial-scm.org/[^] và cài đặt nó nếu bạn chưa cài đặt.

Bây giờ bạn đã sẵn sàng để quẩy.
Tất cả những gì bạn cần là một kho chứa Mercurial mà bạn có thể đẩy đến.
May mắn thay, mọi kho chứa Mercurial đều có thể hoạt động theo cách này, vì vậy chúng ta sẽ chỉ sử dụng kho chứa "hello world" mà mọi người sử dụng để học Mercurial:

[source,console]
----
$ hg clone http://selenic.com/repo/hello /tmp/hello
----

===== Bắt đầu

Bây giờ chúng ta đã có một kho chứa "`phía máy chủ`" phù hợp, chúng ta có thể đi qua một quy trình làm việc điển hình.
Như bạn sẽ thấy, hai hệ thống này đủ giống nhau để không có nhiều ma sát.

Như mọi khi với Git, đầu tiên chúng ta sao chép (clone):

[source,console]
----
$ git clone hg::/tmp/hello /tmp/hello-git
$ cd /tmp/hello-git
$ git log --oneline --graph --decorate
* ac7955c (HEAD, origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master, master) Create a makefile
* 65bb417 Create a standard 'hello, world' program
----

Bạn sẽ nhận thấy rằng làm việc với một kho chứa Mercurial sử dụng lệnh `git clone` tiêu chuẩn.
Đó là bởi vì git-remote-hg đang hoạt động ở mức khá thấp, sử dụng một cơ chế tương tự như cách giao thức HTTP/S của Git được triển khai (các trình trợ giúp từ xa).
Vì Git và Mercurial đều được thiết kế để mọi máy khách có một bản sao đầy đủ của lịch sử kho chứa, lệnh này tạo ra một bản sao đầy đủ, bao gồm tất cả lịch sử của dự án, và thực hiện nó khá nhanh chóng.

Lệnh `log` hiển thị hai commit, commit mới nhất được trỏ đến bởi một loạt các tham chiếu.
Hóa ra một số trong số này thực sự không có ở đó.
Hãy xem những gì thực sự có trong thư mục `.git`:

[source,console]
----
$ tree .git/refs
.git/refs
├── heads
│   └── master
├── hg
│   └── origin
│       ├── bookmarks
│       │   └── master
│       └── branches
│           └── default
├── notes
│   └── hg
├── remotes
│   └── origin
│       └── HEAD
└── tags

9 directories, 5 files
----

Git-remote-hg đang cố gắng làm cho mọi thứ trở nên giống Git hơn về mặt thành ngữ, nhưng bên dưới nó đang quản lý ánh xạ khái niệm giữa hai hệ thống hơi khác nhau.
Thư mục `refs/hg` là nơi các tham chiếu từ xa thực tế được lưu trữ.
Ví dụ, `refs/hg/origin/branches/default` là một tập tin tham chiếu Git chứa SHA-1 bắt đầu bằng "`ac7955c`", đó là commit mà `master` trỏ đến.
Vì vậy, thư mục `refs/hg` giống như một `refs/remotes/origin` giả, nhưng nó có sự phân biệt thêm giữa dấu trang (bookmarks) và nhánh (branches).

Tập tin `notes/hg` là điểm bắt đầu cho cách git-remote-hg ánh xạ các hàm băm commit Git sang các ID changeset Mercurial.
Hãy khám phá một chút:

[source,console]
----
$ cat notes/hg
d4c10386...

$ git cat-file -p d4c10386...
tree 1781c96...
author remote-hg <> 1408066400 -0800
committer remote-hg <> 1408066400 -0800

Notes for master

$ git ls-tree 1781c96...
100644 blob ac9117f...	65bb417...
100644 blob 485e178...	ac7955c...

$ git cat-file -p ac9117f
0a04b987be5ae354b710cefeba0e2d9de7ad41a9
----

Vì vậy `refs/notes/hg` trỏ đến một cây (tree), trong cơ sở dữ liệu đối tượng Git là một danh sách các đối tượng khác có tên.
`git ls-tree` xuất ra chế độ, loại, hàm băm đối tượng, và tên tập tin cho các mục bên trong một cây.
Khi chúng ta đào sâu xuống một trong các mục cây, chúng ta thấy rằng bên trong nó là một blob có tên "`ac9117f`" (hàm băm SHA-1 của commit được trỏ đến bởi `master`), với nội dung "`0a04b98`" (là ID của changeset Mercurial tại đỉnh của nhánh `default`).

Tin tốt là chúng ta hầu như không phải lo lắng về tất cả những điều này.
Quy trình làm việc điển hình sẽ không khác nhiều so với làm việc với một máy từ xa Git.

Có một điều nữa chúng ta nên chú ý trước khi tiếp tục: bỏ qua (ignores).
Mercurial và Git sử dụng cơ chế rất giống nhau cho việc này, nhưng có khả năng bạn không muốn thực sự commit một tập tin `.gitignore` vào một kho chứa Mercurial.
May mắn thay, Git có một cách để bỏ qua các tập tin cục bộ đối với một kho chứa trên đĩa, và định dạng Mercurial tương thích với Git, vì vậy bạn chỉ cần sao chép nó qua:

[source,console]
----
$ cp .hgignore .git/info/exclude
----

Tập tin `.git/info/exclude` hoạt động giống như một `.gitignore`, nhưng không được bao gồm trong các commit.

===== Quy trình làm việc

Giả sử chúng ta đã thực hiện một số công việc và thực hiện một số commit trên nhánh `master`, và bạn đã sẵn sàng đẩy nó lên kho chứa từ xa.
Đây là những gì kho chứa của chúng ta trông giống như ngay bây giờ:

[source,console]
----
$ git log --oneline --graph --decorate
* ba04a2a (HEAD, master) Update makefile
* d25d16f Goodbye
* ac7955c (origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master) Create a makefile
* 65bb417 Create a standard 'hello, world' program
----

Nhánh `master` của chúng ta đi trước `origin/master` hai commit, nhưng hai commit đó chỉ tồn tại trên máy cục bộ của chúng ta.
Hãy xem liệu có ai khác đã và đang làm công việc quan trọng cùng lúc không:

[source,console]
----
$ git fetch
From hg::/tmp/hello
   ac7955c..df85e87  master     -> origin/master
   ac7955c..df85e87  branches/default -> origin/branches/default
$ git log --oneline --graph --decorate --all
* 7b07969 (refs/notes/hg) Notes for default
* d4c1038 Notes for master
* df85e87 (origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master) Add some documentation
| * ba04a2a (HEAD, master) Update makefile
| * d25d16f Goodbye
|/
* ac7955c Create a makefile
* 65bb417 Create a standard 'hello, world' program
----

Vì chúng ta đã sử dụng cờ `--all`, chúng ta thấy các tham chiếu "`notes`" được sử dụng nội bộ bởi git-remote-hg, nhưng chúng ta có thể bỏ qua chúng.
Phần còn lại là những gì chúng ta mong đợi; `origin/master` đã tiến thêm một commit, và lịch sử của chúng ta hiện đã phân kỳ.
Không giống như các hệ thống khác chúng ta làm việc trong chương này, Mercurial có khả năng xử lý các lần trộn, vì vậy chúng ta sẽ không làm bất cứ điều gì cầu kỳ.

[source,console]
----
$ git merge origin/master
Auto-merging hello.c
Merge made by the 'recursive' strategy.
 hello.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)
$ git log --oneline --graph --decorate
*   0c64627 (HEAD, master) Merge remote-tracking branch 'origin/master'
|\
| * df85e87 (origin/master, origin/branches/default, origin/HEAD, refs/hg/origin/branches/default, refs/hg/origin/bookmarks/master) Add some documentation
* | ba04a2a Update makefile
* | d25d16f Goodbye
|/
* ac7955c Create a makefile
* 65bb417 Create a standard 'hello, world' program
----

Hoàn hảo.
Chúng ta chạy các bài kiểm tra và mọi thứ đều vượt qua, vì vậy chúng ta đã sẵn sàng chia sẻ công việc của mình với phần còn lại của nhóm:

[source,console]
----
$ git push
To hg::/tmp/hello
   df85e87..0c64627  master -> master
----

Thế là xong!
Nếu bạn xem xét kho chứa Mercurial, bạn sẽ thấy rằng điều này đã làm những gì chúng ta mong đợi:

[source,console]
----
$ hg log -G --style compact
o    5[tip]:4,2   dc8fa4f932b8   2014-08-14 19:33 -0700   ben
|\     Merge remote-tracking branch 'origin/master'
| |
| o  4   64f27bcefc35   2014-08-14 19:27 -0700   ben
| |    Update makefile
| |
| o  3:1   4256fc29598f   2014-08-14 19:27 -0700   ben
| |    Goodbye
| |
@ |  2   7db0b4848b3c   2014-08-14 19:30 -0700   ben
|/     Add some documentation
|
o  1   82e55d328c8c   2005-08-26 01:21 -0700   mpm
|    Create a makefile
|
o  0   0a04b987be5a   2005-08-26 01:20 -0700   mpm
     Create a standard 'hello, world' program
----

Changeset được đánh số _2_ được thực hiện bởi Mercurial, và các changeset được đánh số _3_ và _4_ được thực hiện bởi git-remote-hg, bằng cách đẩy các commit được thực hiện bằng Git.

===== Nhánh và Dấu trang

Git chỉ có một loại nhánh: một tham chiếu di chuyển khi các commit được thực hiện.
Trong Mercurial, loại tham chiếu này được gọi là một "`dấu trang`" (bookmark), và nó hoạt động theo cách tương tự như một nhánh Git.

Khái niệm về một "`nhánh`" của Mercurial nặng nề hơn.
Nhánh mà một changeset được thực hiện trên đó được ghi lại _cùng với changeset_, điều đó có nghĩa là nó sẽ luôn nằm trong lịch sử kho chứa.
Dưới đây là một ví dụ về một commit được thực hiện trên nhánh `develop`:

[source,console]
----
$ hg log -l 1
changeset:   6:8f65e5e02793
branch:      develop
tag:         tip
user:        Ben Straub <ben@straub.cc>
date:        Thu Aug 14 20:06:38 2014 -0700
summary:     More documentation
----

Lưu ý dòng bắt đầu bằng "`branch`".
Git không thể thực sự sao chép điều này (và không cần phải làm vậy; cả hai loại nhánh đều có thể được biểu diễn dưới dạng tham chiếu Git), nhưng git-remote-hg cần hiểu sự khác biệt, bởi vì Mercurial quan tâm.

Tạo các dấu trang Mercurial cũng dễ dàng như tạo các nhánh Git.
Ở phía Git:

[source,console]
----
$ git checkout -b featureA
Switched to a new branch 'featureA'
$ git push origin featureA
To hg::/tmp/hello
 * [new branch]      featureA -> featureA
----

Chỉ có vậy thôi.
Ở phía Mercurial, nó trông như thế này:

[source,console]
----
$ hg bookmarks
   featureA                  5:bd5ac26f11f9
$ hg log --style compact -G
@  6[tip]   8f65e5e02793   2014-08-14 20:06 -0700   ben
|    More documentation
|
o    5[featureA]:4,2   bd5ac26f11f9   2014-08-14 20:02 -0700   ben
|\     Merge remote-tracking branch 'origin/master'
| |
| o  4   0434aaa6b91f   2014-08-14 20:01 -0700   ben
| |    update makefile
| |
| o  3:1   318914536c86   2014-08-14 20:00 -0700   ben
| |    goodbye
| |
o |  2   f098c7f45c4f   2014-08-14 20:01 -0700   ben
|/     Add some documentation
|
o  1   82e55d328c8c   2005-08-26 01:21 -0700   mpm
|    Create a makefile
|
o  0   0a04b987be5a   2005-08-26 01:20 -0700   mpm
     Create a standard 'hello, world' program
----

Lưu ý thẻ `[featureA]` mới trên bản sửa đổi 5.
Những thứ này hoạt động chính xác như các nhánh Git ở phía Git, với một ngoại lệ: bạn không thể xóa một dấu trang từ phía Git (đây là một hạn chế của các trình trợ giúp từ xa).

Bạn cũng có thể làm việc trên một nhánh Mercurial "`hạng nặng`": chỉ cần đặt một nhánh trong không gian tên `branches`:

[source,console]
----
$ git checkout -b branches/permanent
Switched to a new branch 'branches/permanent'
$ vi Makefile
$ git commit -am 'A permanent change'
$ git push origin branches/permanent
To hg::/tmp/hello
 * [new branch]      branches/permanent -> branches/permanent
----

Đây là những gì nó trông giống như ở phía Mercurial:

[source,console]
----
$ hg branches
permanent                      7:a4529d07aad4
develop                        6:8f65e5e02793
default                        5:bd5ac26f11f9 (inactive)
$ hg log -G
o  changeset:   7:a4529d07aad4
|  branch:      permanent
|  tag:         tip
|  parent:      5:bd5ac26f11f9
|  user:        Ben Straub <ben@straub.cc>
|  date:        Thu Aug 14 20:21:09 2014 -0700
|  summary:     A permanent change
|
| @  changeset:   6:8f65e5e02793
|/   branch:      develop
|    user:        Ben Straub <ben@straub.cc>
|    date:        Thu Aug 14 20:06:38 2014 -0700
|    summary:     More documentation
|
o    changeset:   5:bd5ac26f11f9
|\   bookmark:    featureA
| |  parent:      4:0434aaa6b91f
| |  parent:      2:f098c7f45c4f
| |  user:        Ben Straub <ben@straub.cc>
| |  date:        Thu Aug 14 20:02:21 2014 -0700
| |  summary:     Merge remote-tracking branch 'origin/master'
[...]
----

Tên nhánh "`permanent`" đã được ghi lại với changeset được đánh dấu _7_.

Từ phía Git, làm việc với một trong hai kiểu nhánh này là giống nhau: chỉ cần checkout, commit, fetch, merge, pull, và push như bạn thường làm.
Một điều bạn nên biết là Mercurial không hỗ trợ viết lại lịch sử, chỉ thêm vào nó.
Đây là những gì kho chứa Mercurial của chúng ta trông giống như sau một lần rebase tương tác và một lần đẩy bắt buộc (force-push):

[source,console]
----
$ hg log --style compact -G
o  10[tip]   99611176cbc9   2014-08-14 20:21 -0700   ben
|    A permanent change
|
o  9   f23e12f939c3   2014-08-14 20:01 -0700   ben
|    Add some documentation
|
o  8:1   c16971d33922   2014-08-14 20:00 -0700   ben
|    goodbye
|
| o  7:5   a4529d07aad4   2014-08-14 20:21 -0700   ben
| |    A permanent change
| |
| | @  6   8f65e5e02793   2014-08-14 20:06 -0700   ben
| |/     More documentation
| |
| o    5[featureA]:4,2   bd5ac26f11f9   2014-08-14 20:02 -0700   ben
| |\     Merge remote-tracking branch 'origin/master'
| | |
| | o  4   0434aaa6b91f   2014-08-14 20:01 -0700   ben
| | |    update makefile
| | |
| | +---o  3:1   318914536c86   2014-08-14 20:00 -0700   ben
| |      goodbye
| |
| o  2   f098c7f45c4f   2014-08-14 20:01 -0700   ben
|/     Add some documentation
|
o  1   82e55d328c8c   2005-08-26 01:21 -0700   mpm
|    Create a makefile
|
o  0   0a04b987be5a   2005-08-26 01:20 -0700   mpm
     Create a standard "hello, world" program
----

Các changeset _8_, _9_, và _10_ đã được tạo và thuộc về nhánh `permanent`, nhưng các changeset cũ vẫn còn đó.
Điều này có thể *rất* khó hiểu đối với các đồng đội của bạn, những người đang sử dụng Mercurial, vì vậy hãy cố gắng tránh nó.

===== Tóm tắt Mercurial

Git và Mercurial đủ giống nhau để làm việc qua ranh giới là khá không đau đớn.
Nếu bạn tránh thay đổi lịch sử đã rời khỏi máy của mình (như thường được khuyến nghị), bạn thậm chí có thể không biết rằng đầu bên kia là Mercurial.
