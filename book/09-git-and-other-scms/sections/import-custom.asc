[[_custom_importer]]
==== Một Trình Nhập Tùy chỉnh

(((git commands, fast-import)))
(((Importing, from others)))
Nếu hệ thống của bạn không phải là một trong những hệ thống trên, bạn nên tìm kiếm một trình nhập trực tuyến – các trình nhập chất lượng có sẵn cho nhiều hệ thống khác, bao gồm CVS, Clear Case, Visual Source Safe, thậm chí cả một thư mục lưu trữ.
Nếu không có công cụ nào trong số này hoạt động cho bạn, bạn có một công cụ khó hiểu hơn, hoặc bạn cần một quy trình nhập tùy chỉnh hơn, bạn nên sử dụng `git fast-import`.
Lệnh này đọc các hướng dẫn đơn giản từ stdin để ghi dữ liệu Git cụ thể.
Cách này dễ dàng hơn nhiều để tạo các đối tượng Git so với chạy các lệnh Git thô hoặc cố gắng ghi các đối tượng thô (xem <<ch10-git-internals#ch10-git-internals>> để biết thêm thông tin).
Bằng cách này, bạn có thể viết một tập tin kịch bản nhập đọc thông tin cần thiết ra khỏi hệ thống bạn đang nhập và in các hướng dẫn đơn giản ra stdout.
Sau đó, bạn có thể chạy chương trình này và chuyển đầu ra của nó qua `git fast-import`.

Để minh họa nhanh, bạn sẽ viết một trình nhập đơn giản.
Giả sử bạn làm việc trong `current`, bạn sao lưu dự án của mình bằng cách thỉnh thoảng sao chép thư mục vào một thư mục sao lưu `back_YYYY_MM_DD` có dấu thời gian, và bạn muốn nhập điều này vào Git.
Cấu trúc thư mục của bạn trông như thế này:

[source,console]
----
$ ls /opt/import_from
back_2014_01_02
back_2014_01_04
back_2014_01_14
back_2014_02_03
current
----

Để nhập một thư mục Git, bạn cần xem xét cách Git lưu trữ dữ liệu của nó.
Như bạn có thể nhớ, Git về cơ bản là một danh sách liên kết của các đối tượng commit trỏ đến một ảnh chụp nhanh của nội dung.
Tất cả những gì bạn phải làm là bảo `fast-import` các ảnh chụp nhanh nội dung là gì, dữ liệu commit nào trỏ đến chúng, và thứ tự chúng đi vào.
Chiến lược của bạn sẽ là đi qua các ảnh chụp nhanh từng cái một và tạo các commit với nội dung của mỗi thư mục, liên kết mỗi commit trở lại cái trước đó.

Như chúng ta đã làm trong <<ch08-customizing-git#_an_example_git_enforced_policy>>, chúng ta sẽ viết điều này bằng Ruby, bởi vì đó là những gì chúng ta thường làm việc và nó có xu hướng dễ đọc.
Bạn có thể viết ví dụ này khá dễ dàng trong bất cứ thứ gì bạn quen thuộc – nó chỉ cần in thông tin thích hợp ra `stdout`.
Và, nếu bạn đang chạy trên Windows, điều này có nghĩa là bạn sẽ cần chú ý đặc biệt để không đưa các ký tự xuống dòng kiểu carriage return vào cuối dòng của bạn – `git fast-import` rất cụ thể về việc chỉ muốn line feeds (LF) chứ không phải carriage return line feeds (CRLF) mà Windows sử dụng.

Để bắt đầu, bạn sẽ chuyển vào thư mục đích và xác định mọi thư mục con, mỗi thư mục là một ảnh chụp nhanh mà bạn muốn nhập dưới dạng một commit.
Bạn sẽ chuyển vào mỗi thư mục con và in các lệnh cần thiết để xuất nó.
Vòng lặp chính cơ bản của bạn trông như thế này:

[source,ruby]
----
last_mark = nil

# loop through the directories
Dir.chdir(ARGV[0]) do
  Dir.glob("*").each do |dir|
    next if File.file?(dir)

    # move into the target directory
    Dir.chdir(dir) do
      last_mark = print_export(dir, last_mark)
    end
  end
end
----

Bạn chạy `print_export` bên trong mỗi thư mục, lấy bảng kê khai và dấu của ảnh chụp nhanh trước đó và trả về bảng kê khai và dấu của cái này; bằng cách đó, bạn có thể liên kết chúng đúng cách.
"`Mark`" là thuật ngữ `fast-import` cho một định danh bạn cung cấp cho một commit; khi bạn tạo các commit, bạn cung cấp cho mỗi cái một dấu mà bạn có thể sử dụng để liên kết đến nó từ các commit khác.
Vì vậy, điều đầu tiên cần làm trong phương thức `print_export` của bạn là tạo một dấu từ tên thư mục:

[source,ruby]
----
mark = convert_dir_to_mark(dir)
----

Bạn sẽ làm điều này bằng cách tạo một mảng các thư mục và sử dụng giá trị chỉ mục làm dấu, bởi vì một dấu phải là một số nguyên.
Phương thức của bạn trông như thế này:

[source,ruby]
----
$marks = []
def convert_dir_to_mark(dir)
  if !$marks.include?(dir)
    $marks << dir
  end
  ($marks.index(dir) + 1).to_s
end
----

Bây giờ bạn có một biểu diễn số nguyên của commit của mình, bạn cần một ngày cho siêu dữ liệu commit.
Vì ngày được biểu thị trong tên của thư mục, bạn sẽ phân tích cú pháp nó ra.
Dòng tiếp theo trong tập tin `print_export` của bạn là:

[source,ruby]
----
date = convert_dir_to_date(dir)
----

trong đó `convert_dir_to_date` được định nghĩa là:

[source,ruby]
----
def convert_dir_to_date(dir)
  if dir == 'current'
    return Time.now().to_i
  else
    dir = dir.gsub('back_', '')
    (year, month, day) = dir.split('_')
    return Time.local(year, month, day).to_i
  end
end
----

Điều đó trả về một giá trị số nguyên cho ngày của mỗi thư mục.
Phần thông tin meta cuối cùng bạn cần cho mỗi commit là dữ liệu người commit, mà bạn mã hóa cứng trong một biến toàn cục:

[source,ruby]
----
$author = 'John Doe <john@example.com>'
----

Bây giờ bạn đã sẵn sàng để bắt đầu in ra dữ liệu commit cho trình nhập của mình.
Thông tin ban đầu nói rằng bạn đang định nghĩa một đối tượng commit và nhánh nào nó đang ở, theo sau là dấu bạn đã tạo, thông tin người commit và thông điệp commit, và sau đó là commit trước đó, nếu có.
Mã trông như thế này:

[source,ruby]
----
# print the import information
puts 'commit refs/heads/master'
puts 'mark :' + mark
puts "committer #{$author} #{date} -0700"
export_data('imported from ' + dir)
puts 'from :' + last_mark if last_mark
----

Bạn mã hóa cứng múi giờ (-0700) vì làm như vậy là dễ dàng.
Nếu bạn đang nhập từ một hệ thống khác, bạn phải chỉ định múi giờ như một độ lệch.
Thông điệp commit phải được biểu thị theo một định dạng đặc biệt:

[source]
----
data (size)\n(contents)
----

Định dạng bao gồm từ data, kích thước của dữ liệu cần đọc, một dòng mới, và cuối cùng là dữ liệu.
Vì bạn cần sử dụng cùng một định dạng để chỉ định nội dung tập tin sau này, bạn tạo một phương thức trợ giúp, `export_data`:

[source,ruby]
----
def export_data(string)
  print "data #{string.size}\n#{string}"
end
----

Tất cả những gì còn lại là chỉ định nội dung tập tin cho mỗi ảnh chụp nhanh.
Điều này dễ dàng, vì bạn có mỗi cái trong một thư mục – bạn có thể in ra lệnh `deleteall` theo sau là nội dung của mỗi tập tin trong thư mục.
Git sau đó sẽ ghi lại mỗi ảnh chụp nhanh một cách thích hợp:

[source,ruby]
----
puts 'deleteall'
Dir.glob("**/*").each do |file|
  next if !File.file?(file)
  inline_data(file)
end
----

Lưu ý: Vì nhiều hệ thống nghĩ về các bản sửa đổi của họ như các thay đổi từ một commit sang một commit khác, fast-import cũng có thể nhận các lệnh với mỗi commit để chỉ định tập tin nào đã được thêm, xóa, hoặc sửa đổi và nội dung mới là gì.
Bạn có thể tính toán sự khác biệt giữa các ảnh chụp nhanh và chỉ cung cấp dữ liệu này, nhưng làm như vậy phức tạp hơn – bạn cũng có thể cung cấp cho Git tất cả dữ liệu và để nó tìm ra.
Nếu điều này phù hợp hơn với dữ liệu của bạn, hãy kiểm tra trang man `fast-import` để biết chi tiết về cách cung cấp dữ liệu của bạn theo cách này.

Định dạng để liệt kê nội dung tập tin mới hoặc chỉ định một tập tin đã sửa đổi với nội dung mới như sau:

[source]
----
M 644 inline path/to/file
data (size)
(file contents)
----

Ở đây, 644 là chế độ (nếu bạn có các tập tin thực thi, bạn cần phát hiện và chỉ định 755 thay thế), và inline nói rằng bạn sẽ liệt kê nội dung ngay sau dòng này.
Phương thức `inline_data` của bạn trông như thế này:

[source,ruby]
----
def inline_data(file, code = 'M', mode = '644')
  content = File.read(file)
  puts "#{code} #{mode} inline #{file}"
  export_data(content)
end
----

Bạn tái sử dụng phương thức `export_data` bạn đã định nghĩa trước đó, vì nó giống như cách bạn chỉ định dữ liệu thông điệp commit của mình.

Điều cuối cùng bạn cần làm là trả về dấu hiện tại để nó có thể được truyền cho lần lặp tiếp theo:

[source,ruby]
----
return mark
----

[NOTE]
====
Nếu bạn đang chạy trên Windows, bạn sẽ cần đảm bảo rằng bạn thêm một bước bổ sung.
Như đã đề cập trước đó, Windows sử dụng CRLF cho các ký tự dòng mới trong khi `git fast-import` chỉ mong đợi LF.
Để giải quyết vấn đề này và làm cho `git fast-import` hài lòng, bạn cần bảo ruby sử dụng LF thay vì CRLF:

[source,ruby]
----
$stdout.binmode
----
====

Vậy là xong.
Đây là tập tin kịch bản trong toàn bộ của nó:

[source,ruby]
----
#!/usr/bin/env ruby

$stdout.binmode
$author = "John Doe <john@example.com>"

$marks = []
def convert_dir_to_mark(dir)
    if !$marks.include?(dir)
        $marks << dir
    end
    ($marks.index(dir)+1).to_s
end

def convert_dir_to_date(dir)
    if dir == 'current'
        return Time.now().to_i
    else
        dir = dir.gsub('back_', '')
        (year, month, day) = dir.split('_')
        return Time.local(year, month, day).to_i
    end
end

def export_data(string)
    print "data #{string.size}\n#{string}"
end

def inline_data(file, code='M', mode='644')
    content = File.read(file)
    puts "#{code} #{mode} inline #{file}"
    export_data(content)
end

def print_export(dir, last_mark)
    date = convert_dir_to_date(dir)
    mark = convert_dir_to_mark(dir)

    puts 'commit refs/heads/master'
    puts "mark :#{mark}"
    puts "committer #{$author} #{date} -0700"
    export_data("imported from #{dir}")
    puts "from :#{last_mark}" if last_mark

    puts 'deleteall'
    Dir.glob("**/*").each do |file|
        next if !File.file?(file)
        inline_data(file)
    end
    mark
end

# Loop through the directories
last_mark = nil
Dir.chdir(ARGV[0]) do
    Dir.glob("*").each do |dir|
        next if File.file?(dir)

        # move into the target directory
        Dir.chdir(dir) do
            last_mark = print_export(dir, last_mark)
        end
    end
end
----

Nếu bạn chạy tập tin kịch bản này, bạn sẽ nhận được nội dung trông giống như thế này:

[source,console]
----
$ ruby import.rb /opt/import_from
commit refs/heads/master
mark :1
committer John Doe <john@example.com> 1388649600 -0700
data 29
imported from back_2014_01_02deleteall
M 644 inline README.md
data 28
# Hello

This is my readme.
commit refs/heads/master
mark :2
committer John Doe <john@example.com> 1388822400 -0700
data 29
imported from back_2014_01_04from :1
deleteall
M 644 inline main.rb
data 34
#!/bin/env ruby

puts "Hey there"
M 644 inline README.md
(...)
----

Để chạy trình nhập, hãy chuyển đầu ra này qua `git fast-import` trong khi ở trong thư mục Git bạn muốn nhập vào.
Bạn có thể tạo một thư mục mới và sau đó chạy `git init` trong đó cho một điểm khởi đầu, và sau đó chạy tập tin kịch bản của bạn:

[source,console]
----
$ git init
Initialized empty Git repository in /opt/import_to/.git/
$ ruby import.rb /opt/import_from | git fast-import
git-fast-import statistics:
---------------------------------------------------------------------
Alloc'd objects:       5000
Total objects:           13 (         6 duplicates                  )
      blobs  :            5 (         4 duplicates          3 deltas of          5 attempts)
      trees  :            4 (         1 duplicates          0 deltas of          4 attempts)
      commits:            4 (         1 duplicates          0 deltas of          0 attempts)
      tags   :            0 (         0 duplicates          0 deltas of          0 attempts)
Total branches:           1 (         1 loads     )
      marks:           1024 (         5 unique    )
      atoms:              2
Memory total:          2344 KiB
       pools:          2110 KiB
     objects:           234 KiB
---------------------------------------------------------------------
pack_report: getpagesize()            =       4096
pack_report: core.packedGitWindowSize = 1073741824
pack_report: core.packedGitLimit      = 8589934592
pack_report: pack_used_ctr            =         10
pack_report: pack_mmap_calls          =          5
pack_report: pack_open_windows        =          2 /          2
pack_report: pack_mapped              =       1457 /       1457
---------------------------------------------------------------------
----

Như bạn có thể thấy, khi nó hoàn thành thành công, nó cung cấp cho bạn một loạt thống kê về những gì nó đã hoàn thành.
Trong trường hợp này, bạn đã nhập tổng cộng 13 đối tượng cho 4 commit vào 1 nhánh.
Bây giờ, bạn có thể chạy `git log` để xem lịch sử mới của mình:

[source,console]
----
$ git log -2
commit 3caa046d4aac682a55867132ccdfbe0d3fdee498
Author: John Doe <john@example.com>
Date:   Tue Jul 29 19:39:04 2014 -0700

    imported from current

commit 4afc2b945d0d3c8cd00556fbe2e8224569dc9def
Author: John Doe <john@example.com>
Date:   Mon Feb 3 01:00:00 2014 -0700

    imported from back_2014_02_03
----

Đó rồi – một kho chứa Git đẹp, sạch sẽ.
Điều quan trọng cần lưu ý là không có gì được check out – bạn không có bất kỳ tập tin nào trong thư mục làm việc của mình lúc đầu.
Để lấy chúng, bạn phải reset nhánh của mình đến nơi `master` hiện tại:

[source,console]
----
$ ls
$ git reset --hard master
HEAD is now at 3caa046 imported from current
$ ls
README.md main.rb
----

Bạn có thể làm nhiều hơn nữa với công cụ `fast-import` – xử lý các chế độ khác nhau, dữ liệu nhị phân, nhiều nhánh và trộn, thẻ, chỉ báo tiến trình, và nhiều hơn nữa.
Một số ví dụ về các tình huống phức tạp hơn có sẵn trong thư mục `contrib/fast-import` của mã nguồn Git.
