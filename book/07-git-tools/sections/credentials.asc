[[_credential_caching]]
=== Lưu trữ Thông tin đăng nhập

(((credentials)))
(((git commands, credential)))
Nếu bạn sử dụng giao thức SSH để kết nối với các remote, bạn có thể có một khóa không có mật khẩu, cho phép bạn truyền dữ liệu an toàn mà không cần nhập tên người dùng và mật khẩu.
Tuy nhiên, điều này không thể thực hiện được với các giao thức HTTP -- mỗi kết nối cần tên người dùng và mật khẩu.
Điều này thậm chí còn khó khăn hơn đối với các hệ thống có xác thực hai yếu tố, nơi mã thông báo bạn sử dụng làm mật khẩu được tạo ngẫu nhiên và không thể đọc được.

May mắn thay, Git có một hệ thống thông tin đăng nhập có thể giúp ích điều này.
Git có một vài tùy chọn được cung cấp sẵn:

* Mặc định là không lưu vào bộ nhớ cache.
  Mỗi kết nối sẽ nhắc bạn nhập tên người dùng và mật khẩu.
* Chế độ "`cache`" giữ thông tin đăng nhập trong bộ nhớ trong một khoảng thời gian nhất định.
  Không có mật khẩu nào được lưu trữ trên đĩa, và chúng sẽ bị xóa khỏi bộ nhớ cache sau 15 phút.
* Chế độ "`store`" lưu thông tin đăng nhập vào một tệp văn bản thuần túy trên đĩa, và chúng không bao giờ hết hạn.
  Điều này có nghĩa là cho đến khi bạn thay đổi mật khẩu cho máy chủ Git, bạn sẽ không bao giờ phải nhập lại thông tin đăng nhập của mình.
  Nhược điểm của phương pháp này là mật khẩu của bạn được lưu trữ dưới dạng văn bản rõ ràng trong một tệp thuần túy trong thư mục chính của bạn.
* Nếu bạn đang sử dụng macOS, Git đi kèm với chế độ "`osxkeychain`", lưu thông tin đăng nhập vào chuỗi khóa an toàn được đính kèm với tài khoản hệ thống của bạn.
  Phương pháp này lưu trữ thông tin đăng nhập trên đĩa, và chúng không bao giờ hết hạn, nhưng chúng được mã hóa bằng cùng một hệ thống lưu trữ chứng chỉ HTTPS và tự động điền của Safari.
* Nếu bạn đang sử dụng Windows, bạn có thể bật tính năng *Git Credential Manager* khi cài đặt https://gitforwindows.org/[Git for Windows] hoặc cài đặt riêng https://github.com/git-ecosystem/git-credential-manager/releases/latest[GCM mới nhất] dưới dạng một dịch vụ độc lập.
  Điều này tương tự như trình trợ giúp "`osxkeychain`" được mô tả ở trên, nhưng sử dụng Windows Credential Store để kiểm soát thông tin nhạy cảm.
  Nó cũng có thể phục vụ thông tin đăng nhập cho WSL1 hoặc WSL2.
  Xem https://github.com/git-ecosystem/git-credential-manager#readme[Hướng dẫn cài đặt GCM] để biết thêm thông tin.

Bạn có thể chọn một trong các phương pháp này bằng cách đặt giá trị cấu hình Git:

[source,console]
----
$ git config --global credential.helper cache
----

Một số trình trợ giúp này có các tùy chọn.
Trình trợ giúp "`store`" có thể nhận đối số `--file <path>`, tùy chỉnh nơi tệp văn bản thuần túy được lưu (mặc định là `~/.git-credentials`).
Trình trợ giúp "`cache`" chấp nhận tùy chọn `--timeout <seconds>`, thay đổi khoảng thời gian daemon của nó được giữ chạy (mặc định là "`900`", hoặc 15 phút).
Đây là một ví dụ về cách bạn sẽ cấu hình trình trợ giúp "`store`" với một tên tệp tùy chỉnh:

[source,console]
----
$ git config --global credential.helper 'store --file ~/.my-credentials'
----

Git thậm chí còn cho phép bạn cấu hình một vài trình trợ giúp.
Khi tìm kiếm thông tin đăng nhập cho một máy chủ cụ thể, Git sẽ truy vấn chúng theo thứ tự, và dừng lại sau khi câu trả lời đầu tiên được cung cấp.
Khi lưu thông tin đăng nhập, Git sẽ gửi tên người dùng và mật khẩu đến _tất cả_ các trình trợ giúp trong danh sách, và chúng có thể chọn làm gì với chúng.
Đây là những gì một `.gitconfig` sẽ trông như thế nào nếu bạn có một tệp thông tin đăng nhập trên một ổ đĩa USB, nhưng muốn sử dụng bộ nhớ cache trong bộ nhớ để tiết kiệm một số lần gõ nếu ổ đĩa không được cắm vào:

[source,ini]
----
[credential]
    helper = store --file /mnt/thumbdrive/.git-credentials
    helper = cache --timeout 30000
----

==== Bên dưới lớp vỏ

Tất cả điều này hoạt động như thế nào?
Lệnh gốc của Git cho hệ thống trợ giúp thông tin đăng nhập là `git credential`, nhận một lệnh làm đối số, và sau đó nhiều đầu vào hơn thông qua stdin.

Điều này có thể dễ hiểu hơn với một ví dụ.
Giả sử rằng một trình trợ giúp thông tin đăng nhập đã được cấu hình, và trình trợ giúp đã lưu trữ thông tin đăng nhập cho `mygithost`.
Đây là một phiên làm việc sử dụng lệnh "`fill`", được gọi khi Git đang cố gắng tìm thông tin đăng nhập cho một máy chủ:

[source,console]
----
$ git credential fill <1>
protocol=https <2>
host=mygithost
<3>
protocol=https <4>
host=mygithost
username=bob
password=s3cre7
$ git credential fill <5>
protocol=https
host=unknownhost

Username for 'https://unknownhost': bob
Password for 'https://bob@unknownhost':
protocol=https
host=unknownhost
username=bob
password=s3cre7
----

<1> Đây là dòng lệnh khởi tạo tương tác.
<2> Git-credential sau đó đang chờ đầu vào trên stdin.
    Chúng tôi cung cấp cho nó những gì chúng tôi biết: giao thức và tên máy chủ.
<3> Một dòng trống cho biết đầu vào đã hoàn tất, và hệ thống thông tin đăng nhập nên trả lời với những gì nó biết.
<4> Git-credential sau đó tiếp quản, và ghi vào stdout với các bit thông tin nó tìm thấy.
<5> Nếu không tìm thấy thông tin đăng nhập, Git hỏi người dùng tên người dùng và mật khẩu, và cung cấp chúng lại cho stdout gọi (ở đây chúng được đính kèm vào cùng một bảng điều khiển).

Hệ thống thông tin đăng nhập thực sự đang gọi một chương trình riêng biệt với chính Git; chương trình nào và cách nào phụ thuộc vào giá trị cấu hình `credential.helper`.
Có một số dạng nó có thể nhận:

[options="header"]
|======
| Giá trị cấu hình | Hành vi
| `foo` | Chạy `git-credential-foo`
| `foo -a --opt=bcd` | Chạy `git-credential-foo -a --opt=bcd`
| `/absolute/path/foo -xyz` | Chạy `/absolute/path/foo -xyz`
| `!f() { echo "password=s3cre7"; }; f` | Mã sau `!` được đánh giá trong shell
|======

Vì vậy, các trình trợ giúp được mô tả ở trên thực sự có tên là `git-credential-cache`, `git-credential-store`, v.v., và chúng ta có thể cấu hình chúng để nhận các đối số dòng lệnh.
Dạng chung cho điều này là "`git-credential-foo [args] <action>.`"
Giao thức stdin/stdout giống như git-credential, nhưng chúng sử dụng một tập hợp hành động hơi khác:

* `get` là một yêu cầu cho một cặp tên người dùng/mật khẩu.
* `store` là một yêu cầu để lưu một tập hợp thông tin đăng nhập trong bộ nhớ của trình trợ giúp này.
* `erase` xóa thông tin đăng nhập cho các thuộc tính đã cho khỏi bộ nhớ của trình trợ giúp này.

Đối với các hành động `store` và `erase`, không cần phản hồi (Git dù sao cũng bỏ qua nó).
Tuy nhiên, đối với hành động `get`, Git rất quan tâm đến những gì trình trợ giúp phải nói.
Nếu trình trợ giúp không biết gì hữu ích, nó có thể đơn giản thoát mà không có đầu ra, nhưng nếu nó biết, nó nên bổ sung thông tin được cung cấp bằng thông tin nó đã lưu trữ.
Đầu ra được coi như một loạt các câu lệnh gán; bất cứ điều gì được cung cấp sẽ thay thế những gì Git đã biết.

Đây là ví dụ tương tự từ trên, nhưng bỏ qua `git-credential` và đi thẳng đến `git-credential-store`:

[source,console]
----
$ git credential-store --file ~/git.store store <1>
protocol=https
host=mygithost
username=bob
password=s3cre7
$ git credential-store --file ~/git.store get <2>
protocol=https
host=mygithost

username=bob <3>
password=s3cre7
----

<1> Ở đây chúng ta yêu cầu `git-credential-store` lưu một số thông tin đăng nhập: tên người dùng "`bob`" và mật khẩu "`s3cre7`" sẽ được sử dụng khi truy cập `https://mygithost`.
<2> Bây giờ chúng ta sẽ truy xuất các thông tin đăng nhập đó.
    Chúng tôi cung cấp các phần của kết nối chúng tôi đã biết (`https://mygithost`), và một dòng trống.
<3> `git-credential-store` trả lời bằng tên người dùng và mật khẩu chúng tôi đã lưu trữ ở trên.

Đây là những gì tệp `~/git.store` trông như thế nào:

[source,ini]
----
https://bob:s3cre7@mygithost
----

Nó chỉ là một loạt các dòng, mỗi dòng chứa một URL được trang trí bằng thông tin đăng nhập.
Các trình trợ giúp `osxkeychain` và `wincred` sử dụng định dạng gốc của các cửa hàng hỗ trợ của chúng, trong đó `cache` sử dụng định dạng trong bộ nhớ riêng của nó (mà không có quy trình nào khác có thể đọc).

==== Bộ nhớ cache Thông tin đăng nhập Tùy chỉnh

Do `git-credential-store` và các trình trợ giúp khác là các chương trình riêng biệt với Git, không khó để nhận ra rằng _bất kỳ_ chương trình nào cũng có thể là trình trợ giúp thông tin đăng nhập Git.
Các trình trợ giúp được cung cấp bởi Git bao gồm nhiều trường hợp sử dụng phổ biến, nhưng không phải tất cả.
Ví dụ, giả sử nhóm của bạn có một số thông tin đăng nhập được chia sẻ với toàn bộ nhóm, có lẽ là để triển khai.
Chúng được lưu trữ trong một thư mục chia sẻ, nhưng bạn không muốn sao chép chúng vào bộ nhớ cache thông tin đăng nhập của riêng mình, bởi vì chúng thay đổi thường xuyên.
Không có trình trợ giúp hiện có nào bao gồm trường hợp này; hãy xem cần làm gì để viết trình trợ giúp của riêng chúng ta.
Có một số tính năng chính mà chương trình này cần phải có:

. Hành động duy nhất chúng ta cần chú ý là `get`; `store` và `erase` là các hoạt động ghi, vì vậy chúng ta sẽ chỉ thoát sạch khi chúng được nhận.
. Định dạng tệp của tệp thông tin đăng nhập được chia sẻ giống như định dạng được sử dụng bởi `git-credential-store`.
. Vị trí của tệp đó khá chuẩn, nhưng chúng ta nên cho phép người dùng truyền một đường dẫn tùy chỉnh trong trường hợp.

Một lần nữa, chúng ta sẽ viết tiện ích mở rộng này bằng Ruby, nhưng bất kỳ ngôn ngữ nào cũng sẽ hoạt động miễn là Git có thể thực thi sản phẩm cuối cùng.
Đây là mã nguồn đầy đủ của trình trợ giúp thông tin đăng nhập mới của chúng ta:

[source,ruby]
----
include::../git-credential-read-only[]
----

<1> Ở đây chúng ta phân tích các tùy chọn dòng lệnh, cho phép người dùng chỉ định tệp đầu vào.
    Mặc định là `~/.git-credentials`.
<2> Chương trình này chỉ phản hồi nếu hành động là `get` và tệp hỗ trợ tồn tại.
<3> Vòng lặp này đọc từ stdin cho đến khi đạt đến dòng trống đầu tiên.
    Các đầu vào được lưu trữ trong băm `known` để tham chiếu sau này.
<4> Vòng lặp này đọc nội dung của tệp lưu trữ, tìm kiếm các kết quả khớp.
    Nếu giao thức, máy chủ và tên người dùng từ `known` khớp với dòng này, chương trình sẽ in kết quả ra stdout và thoát.

Chúng ta sẽ lưu trình trợ giúp của mình dưới dạng `git-credential-read-only`, đặt nó ở đâu đó trong `PATH` của chúng ta và đánh dấu nó là có thể thực thi.
Đây là những gì một phiên tương tác trông như thế nào:

[source,console]
----
$ git credential-read-only --file=/mnt/shared/creds get
protocol=https
host=mygithost
username=bob

protocol=https
host=mygithost
username=bob
password=s3cre7
----

Vì tên của nó bắt đầu bằng "`git-`", chúng ta có thể sử dụng cú pháp đơn giản cho giá trị cấu hình:

[source,console]
----
$ git config --global credential.helper 'read-only --file /mnt/shared/creds'
----

Như bạn có thể thấy, việc mở rộng hệ thống này khá đơn giản, và có thể giải quyết một số vấn đề phổ biến cho bạn và nhóm của bạn.